<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FlakeBench{% endblock %}</title>
    
    <!-- Tailwind CSS (compiled from input.css) -->
    <link rel="stylesheet" href="/static/css/tailwind.css?v=2">
    <style>
        /* Keep all loading spinners visible on light backgrounds. */
        .loading-spinner {
            border-color: #bfdbfe !important;
            border-top-color: #3b82f6 !important;
        }
    </style>
    
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/ws.js"></script>
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/cost-utils.js"></script>
    <script src="/static/js/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script defer src="/static/js/templates_manager.js"></script>
    <script defer src="/static/js/settings_page.js?v=2"></script>
    <!-- Dashboard modules (load before main dashboard.js) -->
    <script defer src="/static/js/dashboard/state.js?v=5"></script>
    <script defer src="/static/js/dashboard/formatters.js?v=5"></script>
    <script defer src="/static/js/dashboard/test-actions.js?v=2"></script>
    <script defer src="/static/js/dashboard/display.js?v=3"></script>
    <script defer src="/static/js/dashboard/workers.js?v=2"></script>
    <script defer src="/static/js/dashboard/find-max.js?v=2"></script>
    <script defer src="/static/js/dashboard/slo.js?v=2"></script>
    <script defer src="/static/js/dashboard/latency.js?v=2"></script>
    <script defer src="/static/js/dashboard/phase.js?v=2"></script>
    <script defer src="/static/js/dashboard/websocket.js?v=2"></script>
    <script defer src="/static/js/dashboard/timers.js?v=2"></script>
    <script defer src="/static/js/dashboard/logs.js?v=2"></script>
    <script defer src="/static/js/dashboard/polling.js?v=2"></script>
    <script defer src="/static/js/dashboard/timeseries.js?v=3"></script>
    <script defer src="/static/js/dashboard/breakdown.js?v=2"></script>
    <script defer src="/static/js/dashboard/step-history.js?v=2"></script>
    <script defer src="/static/js/dashboard/ai.js?v=2"></script>
    <script defer src="/static/js/dashboard/ui.js?v=6"></script>
    <script defer src="/static/js/dashboard/data-loading.js?v=4"></script>
    <script defer src="/static/js/dashboard/historical-metrics.js?v=4"></script>
    <script defer src="/static/js/dashboard/comparison.js?v=1"></script>
    <!-- Main dashboard (composes all modules) -->
    <script defer src="/static/js/dashboard.js?v=6"></script>
    <script defer src="/static/js/display-utils.js"></script>
    <script defer src="/static/js/history.js"></script>
    <script defer src="/static/js/compare_detail.js"></script>
    <script defer src="/static/js/alpine.min.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% include 'components/navbar.html' %}
    
    <main id="main-content" hx-history-elt class="relative">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <div
        id="toast-container"
        class="toast-container"
        aria-live="polite"
        aria-atomic="true"
    ></div>
    
    {% include 'components/footer.html' %}

    <!-- Global Page Navigation Spinner -->
    <div id="page-loading-overlay" class="fixed z-50 hidden pointer-events-none flex items-center justify-center">
        <div class="flex items-center gap-2 rounded-md border border-gray-200 bg-white/95 px-4 py-2 shadow-sm">
            <div style="width: 18px; height: 18px; border: 3px solid #bfdbfe; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <span class="text-sm text-gray-700">Loading data...</span>
        </div>
    </div>
    
    <script>
        function updateActiveNavbarTab() {
            const currentPath = window.location.pathname;
            const links = document.querySelectorAll('#primary-nav a[href], .navbar nav a[href]');

            links.forEach((link) => {
                const href = link.getAttribute('href');
                if (!href) return;

                let hrefPath;
                try {
                    hrefPath = new URL(href, window.location.origin).pathname;
                } catch {
                    return;
                }

                const isMatch = currentPath === hrefPath || currentPath.startsWith(hrefPath + '/');

                link.classList.toggle('active', isMatch);
            });
        }

        document.addEventListener('DOMContentLoaded', updateActiveNavbarTab);
        
        // Global page navigation loading indicator
        const pageOverlay = document.getElementById('page-loading-overlay');
        const OVERLAY_MIN_VISIBLE_MS = 160;
        const OVERLAY_QUIET_MS = 120;
        const OVERLAY_SESSION_MAX_MS = 15000;
        const OVERLAY_BOOTSTRAP_WINDOW_MS = 4000;
        const OVERLAY_POST_SWAP_WINDOW_MS = 1200;
        const OVERLAY_DEBUG_STORAGE_KEY = 'flakebench_overlay_debug';
        let overlayShownAt = 0;
        let overlayVisible = false;
        let overlayHideTimer = null;
        let overlaySessionTimer = null;
        let overlaySessionActive = false;
        let overlayBootstrapArmed = false;
        let pendingMainContentSwap = false;
        let pendingTrackedFetches = 0;
        let lastOverlayActivityAt = 0;
        let overlayDebugEnabled = false;

        try {
            const params = new URLSearchParams(window.location.search || '');
            if (params.get('overlay_debug') === '1') {
                sessionStorage.setItem(OVERLAY_DEBUG_STORAGE_KEY, '1');
            } else if (params.get('overlay_debug') === '0') {
                sessionStorage.removeItem(OVERLAY_DEBUG_STORAGE_KEY);
            }
            overlayDebugEnabled = sessionStorage.getItem(OVERLAY_DEBUG_STORAGE_KEY) === '1';
        } catch (_) {
            overlayDebugEnabled = false;
        }

        function overlayStateSnapshot() {
            return {
                path: window.location.pathname,
                sessionActive: overlaySessionActive,
                visible: overlayVisible,
                pendingMainContentSwap,
                pendingTrackedFetches,
                bootstrapArmed: overlayBootstrapArmed,
                shownAt: overlayShownAt,
                lastActivityAt: lastOverlayActivityAt,
            };
        }

        function overlayDebug(eventName, details = {}) {
            if (!overlayDebugEnabled) return;
            try {
                console.log(`[overlay] ${eventName}`, {
                    ...overlayStateSnapshot(),
                    ...details,
                });
            } catch (_) {}
        }

        window.flakebenchOverlayDebug = {
            enabled() {
                return overlayDebugEnabled;
            },
            setEnabled(enabled) {
                overlayDebugEnabled = !!enabled;
                try {
                    if (overlayDebugEnabled) {
                        sessionStorage.setItem(OVERLAY_DEBUG_STORAGE_KEY, '1');
                    } else {
                        sessionStorage.removeItem(OVERLAY_DEBUG_STORAGE_KEY);
                    }
                } catch (_) {}
                overlayDebug('setEnabled', { enabled: overlayDebugEnabled });
            },
            state() {
                return overlayStateSnapshot();
            },
            show() {
                showPageOverlay('manual');
            },
            hide() {
                forceHidePageOverlay('manual');
            },
        };

        function isMainContentTarget(event) {
            return Boolean(event?.detail?.target && event.detail.target.id === 'main-content');
        }

        function syncPageOverlayBounds() {
            if (!pageOverlay) return;
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            const rect = mainContent.getBoundingClientRect();
            const left = Math.max(0, rect.left);
            const top = Math.max(0, rect.top);
            const width = Math.max(0, rect.width);
            // Keep overlay in the visible viewport region of main content,
            // not full document height (prevents off-screen centered spinner
            // on tall pages like Templates).
            const viewportHeight = Math.max(0, window.innerHeight - top);
            const height = Math.max(160, viewportHeight);
            pageOverlay.style.left = `${left}px`;
            pageOverlay.style.top = `${top}px`;
            pageOverlay.style.width = `${width}px`;
            pageOverlay.style.height = `${height}px`;
            overlayDebug('sync-bounds', {
                rectTop: rect.top,
                rectLeft: rect.left,
                rectWidth: rect.width,
                rectHeight: rect.height,
                overlayTop: top,
                overlayLeft: left,
                overlayWidth: width,
                overlayHeight: height,
            });
        }

        function showPageOverlay(reason = 'unknown') {
            if (!pageOverlay) return;
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
            if (!overlayVisible) {
                syncPageOverlayBounds();
                overlayVisible = true;
                overlayShownAt = Date.now();
                pageOverlay.classList.remove('hidden');
                overlayDebug('show', { reason });
            } else {
                overlayDebug('show-skip-already-visible', { reason });
            }
        }

        function forceHidePageOverlay(reason = 'unknown') {
            if (!pageOverlay) return;
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
            overlayVisible = false;
            pageOverlay.classList.add('hidden');
            overlayDebug('force-hide', { reason });
        }

        function clearOverlayHideTimer() {
            if (overlayHideTimer) {
                clearTimeout(overlayHideTimer);
                overlayHideTimer = null;
            }
        }

        function clearOverlaySessionTimer() {
            if (overlaySessionTimer) {
                clearTimeout(overlaySessionTimer);
                overlaySessionTimer = null;
            }
        }

        function touchOverlayActivity() {
            lastOverlayActivityAt = Date.now();
            overlayDebug('activity');
        }

        function beginOverlaySession(reason = 'unknown') {
            overlaySessionActive = true;
            overlayBootstrapArmed = false;
            pendingMainContentSwap = false;
            pendingTrackedFetches = 0;
            touchOverlayActivity();
            clearOverlaySessionTimer();
            overlaySessionTimer = window.setTimeout(function() {
                // Fail-safe so polling endpoints can never pin the overlay forever.
                endOverlaySession({ hide: true, reason: 'session-timeout' });
            }, OVERLAY_SESSION_MAX_MS);
            overlayDebug('session-begin', { reason });
        }

        function endOverlaySession(options = {}) {
            const hide = options.hide !== false;
            const reason = options.reason || 'unknown';
            overlaySessionActive = false;
            overlayBootstrapArmed = false;
            pendingMainContentSwap = false;
            pendingTrackedFetches = 0;
            clearOverlayHideTimer();
            clearOverlaySessionTimer();
            overlayDebug('session-end', { hide, reason });
            if (hide) {
                hidePageOverlay(`session-end:${reason}`);
            }
        }

        function maybeFinishOverlaySession() {
            if (!overlaySessionActive) {
                overlayDebug('maybe-finish-skip', { reason: 'no-session' });
                return;
            }
            if (overlayBootstrapArmed) {
                overlayDebug('maybe-finish-skip', { reason: 'bootstrap-armed' });
                return;
            }
            if (pendingMainContentSwap) {
                overlayDebug('maybe-finish-skip', { reason: 'pending-main-swap' });
                return;
            }
            if (pendingTrackedFetches > 0) {
                overlayDebug('maybe-finish-skip', { reason: 'pending-fetches' });
                return;
            }
            const idleForMs = Date.now() - lastOverlayActivityAt;
            const waitMs = Math.max(0, OVERLAY_QUIET_MS - idleForMs);
            clearOverlayHideTimer();
            overlayDebug('maybe-finish-arm', { idleForMs, waitMs });
            overlayHideTimer = window.setTimeout(function() {
                if (!overlaySessionActive) return;
                if (pendingMainContentSwap || pendingTrackedFetches > 0) return;
                endOverlaySession({ hide: true, reason: 'idle' });
            }, waitMs);
        }

        function armBootstrapOverlaySession() {
            beginOverlaySession('bootstrap');
            overlayBootstrapArmed = true;
            window.setTimeout(function() {
                if (!overlaySessionActive || !overlayBootstrapArmed) return;
                overlayBootstrapArmed = false;
                overlayDebug('bootstrap-window-complete');
                maybeFinishOverlaySession();
            }, OVERLAY_BOOTSTRAP_WINDOW_MS);
        }

        function armPostSwapTrackingWindow() {
            if (!overlaySessionActive) return;
            overlayBootstrapArmed = true;
            overlayDebug('post-swap-window-start');
            window.setTimeout(function() {
                if (!overlaySessionActive || !overlayBootstrapArmed) return;
                overlayBootstrapArmed = false;
                overlayDebug('post-swap-window-complete');
                maybeFinishOverlaySession();
            }, OVERLAY_POST_SWAP_WINDOW_MS);
        }

        function normalizeFetchUrl(resource) {
            if (typeof resource === 'string') return resource;
            if (resource instanceof URL) return resource.toString();
            if (resource && typeof resource.url === 'string') return resource.url;
            return '';
        }

        function isConfigureRoute() {
            return window.location.pathname === '/configure';
        }

        function isTrackableFetch(resource) {
            const rawUrl = normalizeFetchUrl(resource);
            if (!rawUrl) return false;
            let url;
            try {
                url = new URL(rawUrl, window.location.origin);
            } catch {
                return false;
            }
            if (url.origin !== window.location.origin) return false;
            if (url.pathname.startsWith('/static/')) return false;
            const isAssetRequest = /\.(?:css|js|map|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot)$/i.test(url.pathname);
            if (isAssetRequest) return false;
            return true;
        }

        function hidePageOverlay(reason = 'unknown') {
            if (!overlayVisible) return;
            const elapsed = Date.now() - overlayShownAt;
            const waitMs = Math.max(0, OVERLAY_MIN_VISIBLE_MS - elapsed);
            clearOverlayHideTimer();
            overlayDebug('hide-arm', { reason, elapsed, waitMs });
            overlayHideTimer = window.setTimeout(function() {
                forceHidePageOverlay(reason);
            }, waitMs);
        }

        function isModifiedClick(event) {
            return event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0;
        }

        function isInternalNavigationAnchor(anchor) {
            const href = anchor.getAttribute('href');
            if (!href || href.startsWith('#') || href.startsWith('javascript:')) return false;

            let url;
            try {
                url = new URL(href, window.location.origin);
            } catch {
                return false;
            }

            const isSamePageHash = url.pathname === window.location.pathname &&
                url.search === window.location.search &&
                url.hash;

            if (isSamePageHash) return false;
            if (url.origin !== window.location.origin) return false;
            if (anchor.target && anchor.target !== '_self') return false;
            return true;
        }

        document.body.addEventListener('htmx:beforeRequest', function(event) {
            overlayDebug('htmx:beforeRequest', {
                targetId: event?.detail?.target?.id || null,
                path: event?.detail?.path || null,
            });
            if (isMainContentTarget(event)) {
                if (!overlaySessionActive) {
                    beginOverlaySession('htmx:beforeRequest');
                }
                pendingMainContentSwap = true;
                touchOverlayActivity();
                showPageOverlay('htmx:beforeRequest');
            }
        });
        document.body.addEventListener('htmx:afterSwap', function(event) {
            overlayDebug('htmx:afterSwap', {
                targetId: event?.detail?.target?.id || null,
                path: event?.detail?.pathInfo?.responsePath || null,
            });
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                armPostSwapTrackingWindow();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:afterSettle', function(event) {
            overlayDebug('htmx:afterSettle', {
                targetId: event?.detail?.target?.id || null,
            });
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:responseError', function(event) {
            overlayDebug('htmx:responseError', {
                targetId: event?.detail?.target?.id || null,
                path: event?.detail?.path || null,
            });
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:sendError', function(event) {
            overlayDebug('htmx:sendError', {
                targetId: event?.detail?.target?.id || null,
                path: event?.detail?.path || null,
            });
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });
        document.body.addEventListener('htmx:timeout', function(event) {
            overlayDebug('htmx:timeout', {
                targetId: event?.detail?.target?.id || null,
                path: event?.detail?.path || null,
            });
            if (isMainContentTarget(event)) {
                pendingMainContentSwap = false;
                touchOverlayActivity();
                maybeFinishOverlaySession();
            }
        });

        if (window.fetch) {
            const originalFetch = window.fetch.bind(window);
            window.fetch = function(resource, init) {
                const fetchUrl = normalizeFetchUrl(resource);
                const shouldTrack = isTrackableFetch(resource) && (overlaySessionActive || isConfigureRoute());
                if (shouldTrack) {
                    if (!overlaySessionActive) {
                        beginOverlaySession('fetch');
                    }
                    pendingTrackedFetches += 1;
                    touchOverlayActivity();
                    overlayDebug('fetch-start', {
                        url: fetchUrl,
                        pendingTrackedFetches,
                    });
                    if (overlayVisible || overlayBootstrapArmed || pendingMainContentSwap) {
                        showPageOverlay('fetch-start:active-session');
                    } else if (isConfigureRoute()) {
                        showPageOverlay('fetch-start:configure');
                    }
                } else {
                    overlayDebug('fetch-skip', {
                        url: fetchUrl,
                        sessionActive: overlaySessionActive,
                        configureRoute: isConfigureRoute(),
                    });
                }

                return originalFetch(resource, init).finally(function() {
                    if (!shouldTrack) return;
                    pendingTrackedFetches = Math.max(0, pendingTrackedFetches - 1);
                    touchOverlayActivity();
                    overlayDebug('fetch-end', {
                        url: fetchUrl,
                        pendingTrackedFetches,
                    });
                    maybeFinishOverlaySession();
                });
            };
        }

        // Full-page navigations and reloads (outside HTMX lifecycle)
        document.addEventListener('click', function(event) {
            const anchor = event.target?.closest?.('a[href]');
            if (!anchor) return;
            if (event.defaultPrevented || isModifiedClick(event)) return;
            if (anchor.matches('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete], [hx-boost]')) return;
            if (!isInternalNavigationAnchor(anchor)) return;
            if (!overlaySessionActive) {
                beginOverlaySession('click-nav');
            }
            overlayDebug('click-nav', { href: anchor.getAttribute('href') });
            showPageOverlay('click-nav');
        }, true);

        document.addEventListener('submit', function(event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.matches('[hx-get], [hx-post], [hx-put], [hx-patch], [hx-delete], [hx-boost]')) return;
            if (!overlaySessionActive) {
                beginOverlaySession('form-submit');
            }
            overlayDebug('form-submit', { action: form.getAttribute('action') || null });
            showPageOverlay('form-submit');
        }, true);

        window.addEventListener('beforeunload', function() {
            showPageOverlay('beforeunload');
        });
        window.addEventListener('pageshow', function(event) {
            const persisted = Boolean(event && event.persisted);
            overlayDebug('pageshow', { persisted });
            // Only force-reset on BFCache restores; normal page loads also emit
            // pageshow, and ending the session there races with initial data fetches.
            if (persisted) {
                endOverlaySession({ hide: true, reason: 'pageshow-persisted' });
            }
        });
        window.addEventListener('resize', function() {
            overlayDebug('resize');
            if (overlayVisible) {
                syncPageOverlayBounds();
            }
        });
        // Start bootstrap tracking immediately (before deferred scripts execute)
        // so initial page hydration fetches are tracked.
        armBootstrapOverlaySession();
        
        // Clean up Alpine components BEFORE HTMX swaps content to prevent
        // "X is not defined" errors during navigation transitions.
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            if (window.Alpine && event.detail && event.detail.target) {
                const target = event.detail.target;
                // Destroy all Alpine components in the target before swapping
                const alpineElements = target.querySelectorAll('[x-data]');
                alpineElements.forEach(function(el) {
                    try {
                        if (el._x_dataStack) {
                            window.Alpine.destroyTree(el);
                        }
                    } catch (_) {
                        // Ignore cleanup errors
                    }
                });
            }
        });
        
        document.body.addEventListener('htmx:afterSwap', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver automatically initializes new x-data elements
            // No manual initTree needed - this was causing double-initialization bugs
        });
        document.body.addEventListener('htmx:historyRestore', function(event) {
            updateActiveNavbarTab();
            // Alpine's MutationObserver handles re-initialization automatically
        });
        window.addEventListener('popstate', updateActiveNavbarTab);
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
