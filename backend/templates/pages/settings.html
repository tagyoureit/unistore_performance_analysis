{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Settings - FlakeBench{% endblock %}

{% block content %}
<div x-data="settingsPage()">
    <!-- Page Header -->
    <div class="card card-compact">
        <div class="flex justify-between items-center">
            <div>
                <div class="card-title card-title--compact">Settings</div>
                <p>Manage database connections and application configuration</p>
            </div>
        </div>
    </div>

    <!-- Connections Section -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="card-title card-title--compact">Database Connections</h2>
                <p class="text-sm text-gray-600">
                    Configure connections to Snowflake and Postgres databases.
                    <span class="text-blue-600">Credentials are stored securely in Snowflake.</span>
                </p>
            </div>
            <button 
                type="button" 
                class="btn btn-primary"
                @click="openAddModal()"
            >
                + Add Connection
            </button>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-8">
            <div class="text-gray-500">Loading connections...</div>
        </div>

        <!-- Error State -->
        <div x-show="error && !loading" class="alert alert-error mb-4">
            <span x-text="error"></span>
            <button type="button" class="ml-2 underline" @click="loadConnections()">Retry</button>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && !error && connections.length === 0" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
            <div class="text-gray-500 mb-2">No connections configured</div>
            <button type="button" class="btn btn-secondary btn-sm" @click="openAddModal()">
                Add your first connection
            </button>
        </div>

        <!-- Connections Table -->
        <div x-show="!loading && connections.length > 0" class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Host / Account</th>
                        <th>Credentials</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="conn in connections" :key="conn.connection_id">
                        <tr class="hover:bg-gray-50">
                            <td>
                                <div class="flex items-center gap-2">
                                    <span x-text="conn.connection_name" class="font-medium"></span>
                                    <span x-show="conn.is_default" class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Default</span>
                                </div>
                            </td>
                            <td>
                                <span 
                                    class="text-xs px-2 py-1 rounded"
                                    :class="{
                                        'bg-blue-100 text-blue-800': conn.connection_type === 'SNOWFLAKE',
                                        'bg-green-100 text-green-800': conn.connection_type === 'POSTGRES'
                                    }"
                                    x-text="formatConnectionType(conn.connection_type)"
                                ></span>
                            </td>
                            <td>
                                <span x-text="conn.connection_type === 'SNOWFLAKE' ? conn.account : conn.host"></span>
                                <span x-show="conn.port" class="text-gray-500" x-text="':' + conn.port"></span>
                            </td>
                            <td>
                                <div class="flex items-center gap-1">
                                    <span 
                                        class="text-xs px-2 py-1 rounded"
                                        :class="conn.has_password || conn.has_private_key ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                        x-text="conn.has_password || conn.has_private_key ? 'Configured' : 'Not set'"
                                    ></span>
                                    <span x-show="conn.username" class="text-xs text-gray-500" x-text="'(' + conn.username + ')'"></span>
                                </div>
                            </td>
                            <td class="text-right">
                                <div class="flex justify-end gap-1">
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="openTestModal(conn)"
                                        title="Test connection"
                                    >
                                        Test
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="openEditModal(conn)"
                                        title="Edit connection"
                                    >
                                        Edit
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-secondary"
                                        @click="setDefault(conn)"
                                        :disabled="conn.is_default"
                                        title="Set as default"
                                    >
                                        Set Default
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-danger"
                                        @click="confirmDelete(conn)"
                                        title="Delete connection"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cost Settings Section -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="card-title card-title--compact">Cost Settings</h2>
                <p class="text-sm text-gray-600">Configure cost estimation parameters for benchmarks.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="form-label">Cost per Credit ($)</label>
                <input 
                    type="number" 
                    class="form-input"
                    step="0.01"
                    min="0"
                    x-model.number="costSettings.dollarsPerCredit"
                    @change="saveCostSettings()"
                >
                <p class="text-xs text-gray-500 mt-1">
                    Default: $4.00 (Enterprise tier). Adjust based on your Snowflake contract.
                </p>
            </div>
            
            <div class="flex items-center gap-4 pt-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input 
                        type="checkbox" 
                        x-model="costSettings.showCredits"
                        @change="saveCostSettings()"
                        class="rounded"
                    >
                    <span class="text-sm">Show credits in tooltips</span>
                </label>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t">
            <h4 class="font-medium text-sm mb-2">Warehouse Credit Rates (Reference)</h4>
            <div class="text-xs text-gray-600 grid grid-cols-3 md:grid-cols-6 gap-2">
                <span>XSMALL: 1/hr</span>
                <span>SMALL: 2/hr</span>
                <span>MEDIUM: 4/hr</span>
                <span>LARGE: 8/hr</span>
                <span>XLARGE: 16/hr</span>
                <span>2XLARGE: 32/hr</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Connection Modal -->
    <div 
        x-show="showModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="closeModal()"
        @keydown.escape.window="closeModal()"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" x-text="editingConnection ? 'Edit Connection' : 'Add Connection'"></h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="closeModal()"
                >&times;</button>
            </div>
            
            <form @submit.prevent="saveConnection()">
                <!-- Connection Name -->
                <div class="mb-4">
                    <label class="form-label">Connection Name *</label>
                    <input 
                        type="text" 
                        class="form-input"
                        x-model="formData.connection_name"
                        placeholder="e.g., Production Snowflake"
                        required
                    >
                </div>

                <!-- Connection Type -->
                <div class="mb-4">
                    <label class="form-label">Connection Type *</label>
                    <select 
                        class="form-select"
                        x-model="formData.connection_type"
                        @change="onTypeChange()"
                        required
                    >
                        <option value="">Select type...</option>
                        <option value="SNOWFLAKE">Snowflake</option>
                        <option value="POSTGRES">PostgreSQL</option>
                    </select>
                </div>

                <!-- Snowflake Fields -->
                <div x-show="formData.connection_type === 'SNOWFLAKE'" class="space-y-4">
                    <div>
                        <label class="form-label">Account Identifier *</label>
                        <input 
                            type="text" 
                            class="form-input"
                            x-model="formData.account"
                            placeholder="e.g., org-account or account.region"
                        >
                        <p class="text-xs text-gray-500 mt-1">Your Snowflake account identifier</p>
                    </div>
                    <div>
                        <label class="form-label">Role</label>
                        <input 
                            type="text" 
                            class="form-input"
                            x-model="formData.role"
                            placeholder="e.g., ACCOUNTADMIN"
                        >
                    </div>
                </div>

                <!-- Postgres Fields -->
                <div x-show="formData.connection_type === 'POSTGRES'" class="space-y-4">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-2">
                            <label class="form-label">Host *</label>
                            <input 
                                type="text" 
                                class="form-input"
                                x-model="formData.host"
                                placeholder="e.g., localhost or db.example.com"
                            >
                        </div>
                        <div>
                            <label class="form-label">Port</label>
                            <input 
                                type="number" 
                                class="form-input"
                                x-model.number="formData.port"
                                placeholder="5432"
                            >
                        </div>
                        <div>
                            <label class="form-label">PgBouncer Port</label>
                            <input 
                                type="number" 
                                class="form-input"
                                x-model.number="formData.pgbouncer_port"
                                placeholder="5431"
                            >
                            <p class="text-xs text-gray-500 mt-1">Optional</p>
                        </div>
                    </div>
                </div>

                <!-- Credentials Section -->
                <div x-show="formData.connection_type" class="mt-6 pt-4 border-t">
                    <h4 class="font-medium mb-2">Credentials</h4>
                    <p class="text-xs text-gray-500 mb-4">
                        <span class="text-blue-600">Credentials are stored securely in Snowflake.</span>
                        <span x-show="editingConnection && editingConnection.has_password" class="text-green-600 ml-2">Password already configured - leave blank to keep existing.</span>
                    </p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Username</label>
                            <input 
                                type="text" 
                                class="form-input"
                                x-model="formData.username"
                                :placeholder="editingConnection?.username || 'Enter username'"
                                autocomplete="off"
                            >
                        </div>
                        <div>
                            <label class="form-label">Password</label>
                            <input 
                                type="password" 
                                class="form-input"
                                x-model="formData.password"
                                :placeholder="editingConnection?.has_password ? '••••••••' : 'Enter password'"
                                autocomplete="new-password"
                            >
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-2 mt-6 pt-4 border-t">
                    <button 
                        type="button" 
                        class="btn btn-secondary"
                        @click="closeModal()"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="saving"
                    >
                        <span x-show="!saving" x-text="editingConnection ? 'Save Changes' : 'Create Connection'"></span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Connection Modal -->
    <div 
        x-show="showTestModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="closeTestModal()"
        @keydown.escape.window="closeTestModal()"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Test Connection</h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="closeTestModal()"
                >&times;</button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600">
                    Testing: <span class="font-medium" x-text="testingConnection?.connection_name"></span>
                </p>
                <p x-show="testingConnection?.has_password" class="text-xs text-green-600 mt-1">
                    Using stored credentials (user: <span x-text="testingConnection?.username"></span>)
                </p>
                <p x-show="!testingConnection?.has_password" class="text-xs text-yellow-600 mt-1">
                    No credentials stored - please configure credentials first
                </p>
            </div>

            <!-- Test Result -->
            <div x-show="testResult" class="mt-4">
                <div 
                    class="p-3 rounded"
                    :class="testResult?.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'"
                >
                    <div class="flex items-center gap-2">
                        <span x-show="testResult?.success" class="text-green-600">&#10003;</span>
                        <span x-show="!testResult?.success" class="text-red-600">&#10007;</span>
                        <span 
                            class="font-medium"
                            :class="testResult?.success ? 'text-green-800' : 'text-red-800'"
                            x-text="testResult?.message"
                        ></span>
                    </div>
                    <div x-show="testResult?.latency_ms" class="text-xs text-gray-500 mt-1">
                        Latency: <span x-text="testResult?.latency_ms?.toFixed(0)"></span>ms
                    </div>
                    <div x-show="testResult?.server_version" class="text-xs text-gray-500">
                        Version: <span x-text="testResult?.server_version"></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-2 mt-6">
                <button 
                    type="button" 
                    class="btn btn-secondary"
                    @click="closeTestModal()"
                >
                    Close
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary"
                    @click="runTest()"
                    :disabled="testing || !testingConnection?.has_password"
                >
                    <span x-show="!testing">Test Connection</span>
                    <span x-show="testing">Testing...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div 
        x-show="showDeleteModal" 
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        @click.self="showDeleteModal = false"
        @keydown.escape.window="showDeleteModal = false"
    >
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-red-600">Delete Connection</h3>
                <button 
                    type="button" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                    @click="showDeleteModal = false"
                >&times;</button>
            </div>
            
            <p class="mb-4">
                Are you sure you want to delete <span class="font-medium" x-text="deletingConnection?.connection_name"></span>?
            </p>
            <p class="text-sm text-gray-500 mb-4">
                This will permanently remove the connection and its stored credentials.
            </p>

            <div class="flex justify-end gap-2">
                <button 
                    type="button" 
                    class="btn btn-secondary"
                    @click="showDeleteModal = false"
                >
                    Cancel
                </button>
                <button 
                    type="button" 
                    class="btn btn-danger"
                    @click="deleteConnection()"
                    :disabled="deleting"
                >
                    <span x-show="!deleting">Delete</span>
                    <span x-show="deleting">Deleting...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function settingsPage() {
    return {
        // State
        loading: true,
        error: null,
        connections: [],
        
        // Cost settings
        costSettings: {
            dollarsPerCredit: 4.0,
            showCredits: true,
            currency: 'USD'
        },
        
        // Modal state
        showModal: false,
        editingConnection: null,
        saving: false,
        formData: {
            connection_name: '',
            connection_type: '',
            host: '',
            port: null,
            pgbouncer_port: null,
            account: '',
            role: '',
            username: '',
            password: ''
        },
        
        // Test modal state
        showTestModal: false,
        testingConnection: null,
        testing: false,
        testResult: null,
        
        // Delete modal state
        showDeleteModal: false,
        deletingConnection: null,
        deleting: false,
        
        async init() {
            this.loadCostSettings();
            await this.loadConnections();
        },
        
        // ==================== Connections ====================
        
        async loadConnections() {
            this.loading = true;
            this.error = null;
            try {
                const response = await fetch('/api/connections/');
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const data = await response.json();
                this.connections = data.connections || [];
            } catch (e) {
                this.error = `Failed to load connections: ${e.message}`;
                console.error('Load connections error:', e);
            } finally {
                this.loading = false;
            }
        },
        
        formatConnectionType(type) {
            const labels = {
                'SNOWFLAKE': 'Snowflake',
                'POSTGRES': 'PostgreSQL'
            };
            return labels[type] || type;
        },
        
        // ==================== Add/Edit Modal ====================
        
        openAddModal() {
            this.editingConnection = null;
            this.formData = {
                connection_name: '',
                connection_type: '',
                host: '',
                port: null,
                account: '',
                role: '',
                username: '',
                password: ''
            };
            this.showModal = true;
            
            // Show security warning if using default encryption key (once per session)
            this.checkSecurityWarnings();
        },
        
        async checkSecurityWarnings() {
            const WARNED_KEY = 'flakebench_encryption_warned';
            if (sessionStorage.getItem(WARNED_KEY)) return;
            
            try {
                const res = await fetch('/api/info');
                const data = await res.json();
                const warnings = data.security_warnings || [];
                const encryptionWarning = warnings.find(w => w.code === 'DEFAULT_ENCRYPTION_KEY');
                if (encryptionWarning) {
                    window.toast?.warning(encryptionWarning.message);
                    sessionStorage.setItem(WARNED_KEY, '1');
                }
            } catch (e) {
                // Ignore errors
            }
        },
        
        openEditModal(conn) {
            this.editingConnection = conn;
            this.formData = {
                connection_name: conn.connection_name,
                connection_type: conn.connection_type,
                host: conn.host || '',
                port: conn.port,
                pgbouncer_port: conn.pgbouncer_port,
                account: conn.account || '',
                role: conn.role || '',
                username: '',  // Don't pre-fill - user enters new value if they want to change
                password: ''   // Don't pre-fill - leave blank to keep existing
            };
            this.showModal = true;
        },
        
        closeModal() {
            this.showModal = false;
            this.editingConnection = null;
        },
        
        onTypeChange() {
            // Reset type-specific fields when type changes
            if (this.formData.connection_type === 'SNOWFLAKE') {
                this.formData.host = '';
                this.formData.port = null;
                this.formData.pgbouncer_port = null;
            } else {
                this.formData.account = '';
                this.formData.role = '';
                if (!this.formData.port) {
                    this.formData.port = 5432;
                }
            }
        },
        
        async saveConnection() {
            this.saving = true;
            try {
                const url = this.editingConnection 
                    ? `/api/connections/${this.editingConnection.connection_id}`
                    : '/api/connections/';
                const method = this.editingConnection ? 'PUT' : 'POST';
                
                // Build payload - only include credentials if provided
                const payload = {
                    connection_name: this.formData.connection_name,
                    connection_type: this.formData.connection_type,
                    host: this.formData.host || null,
                    port: this.formData.port || null,
                    pgbouncer_port: this.formData.pgbouncer_port || null,
                    account: this.formData.account || null,
                    role: this.formData.role || null
                };
                
                // Only include credentials if provided (for update, blank means keep existing)
                if (this.formData.username) {
                    payload.username = this.formData.username;
                }
                if (this.formData.password) {
                    payload.password = this.formData.password;
                }
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    // Handle both string and object error.detail (FastAPI validation vs custom errors)
                    const detail = error.detail;
                    const message = typeof detail === 'string' 
                        ? detail 
                        : (detail?.message || JSON.stringify(detail) || 'Failed to save connection');
                    throw new Error(message);
                }
                
                window.toast.success(this.editingConnection ? 'Connection updated' : 'Connection created');
                this.closeModal();
                await this.loadConnections();
            } catch (e) {
                window.toast.error(e.message);
            } finally {
                this.saving = false;
            }
        },
        
        // ==================== Test Modal ====================
        
        openTestModal(conn) {
            this.testingConnection = conn;
            this.testResult = null;
            this.showTestModal = true;
        },
        
        closeTestModal() {
            this.showTestModal = false;
            this.testingConnection = null;
            this.testResult = null;
        },
        
        async runTest() {
            if (!this.testingConnection) return;
            
            this.testing = true;
            this.testResult = null;
            
            try {
                // Test using stored credentials (no body needed)
                const response = await fetch(`/api/connections/${this.testingConnection.connection_id}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})  // Empty body - use stored credentials
                });
                
                this.testResult = await response.json();
                
                if (this.testResult.success) {
                    window.toast.success('Connection successful');
                }
            } catch (e) {
                this.testResult = {
                    success: false,
                    message: `Test failed: ${e.message}`
                };
            } finally {
                this.testing = false;
            }
        },
        
        // ==================== Delete ====================
        
        confirmDelete(conn) {
            this.deletingConnection = conn;
            this.showDeleteModal = true;
        },
        
        async deleteConnection() {
            if (!this.deletingConnection) return;
            
            this.deleting = true;
            try {
                const response = await fetch(`/api/connections/${this.deletingConnection.connection_id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok && response.status !== 204) {
                    throw new Error('Failed to delete connection');
                }
                
                window.toast.success('Connection deleted');
                this.showDeleteModal = false;
                this.deletingConnection = null;
                await this.loadConnections();
            } catch (e) {
                window.toast.error(e.message);
            } finally {
                this.deleting = false;
            }
        },
        
        // ==================== Set Default ====================
        
        async setDefault(conn) {
            try {
                const response = await fetch(`/api/connections/${conn.connection_id}/set-default`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to set default');
                }
                
                window.toast.success(`${conn.connection_name} set as default`);
                await this.loadConnections();
            } catch (e) {
                window.toast.error(e.message);
            }
        },
        
        // ==================== Cost Settings ====================
        
        loadCostSettings() {
            if (window.CostUtils) {
                this.costSettings = window.CostUtils.getCostSettings();
            }
        },
        
        saveCostSettings() {
            if (window.CostUtils) {
                window.CostUtils.saveCostSettings(this.costSettings);
                window.toast.success('Cost settings saved');
            }
        }
    };
}
</script>
{% endblock %}
