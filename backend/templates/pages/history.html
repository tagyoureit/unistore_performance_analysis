{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Test History - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="testHistory()">
    <div class="card card-compact">
        <div class="card-title card-title--compact">Test History</div>
        <p>Browse and manage all previous test results</p>
    </div>

    <details class="card card-collapsible">
        <summary class="card-collapsible__summary">
            <span class="card-title card-title--compact">Filters</span>
        </summary>
        <div class="card-collapsible__body">
            <div class="filters-grid">
            <div>
                <label class="form-label">Table Type</label>
                <select class="form-select" x-model="filters.table_type" @change="applyFilters">
                    <option value="">All Types</option>
                    <option value="STANDARD">Standard</option>
                    <option value="HYBRID">Hybrid</option>
                    <option value="INTERACTIVE">Interactive</option>
                    <option value="POSTGRES">Postgres</option>
                </select>
            </div>

            <div>
                <label class="form-label">Warehouse Size</label>
                <select class="form-select" x-model="filters.warehouse_size" @change="applyFilters">
                    <option value="">All Sizes</option>
                    <option value="XSMALL">X-Small</option>
                    <option value="SMALL">Small</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="LARGE">Large</option>
                    <option value="XLARGE">X-Large</option>
                </select>
            </div>

            <div>
                <label class="form-label">Status</label>
                <select class="form-select" x-model="filters.status" @change="applyFilters">
                    <option value="">All Statuses</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="RUNNING">Running</option>
                    <option value="FAILED">Failed</option>
                    <option value="PAUSED">Paused</option>
                </select>
            </div>

            <div>
                <label class="form-label">Date Range</label>
                <select class="form-select" x-model="filters.date_range" @change="applyFilters">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Past Week</option>
                    <option value="month">Past Month</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filters-custom-range" x-show="filters.date_range === 'custom'">
                <div>
                    <label class="form-label">Start Date</label>
                    <input
                        type="date"
                        class="form-input"
                        x-model="filters.start_date"
                        @change="applyFilters"
                    >
                </div>
                <div>
                    <label class="form-label">End Date</label>
                    <input
                        type="date"
                        class="form-input"
                        x-model="filters.end_date"
                        @change="applyFilters"
                    >
                </div>
            </div>
        </div>

            <div class="form-group">
                <label class="form-label">Search Tests</label>
                <input
                    type="text"
                    class="form-input"
                    x-model="searchQuery"
                    @input.debounce.300ms="searchTests"
                    placeholder="Search by test name..."
                >
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" @click="resetFilters">Reset Filters</button>
                <button type="button" class="btn btn-primary" @click="applyFilters">Apply</button>
            </div>

            <div x-show="searchError" class="alert alert-error mb-4">
                <strong>Search failed.</strong>
                <span x-text="searchError"></span>
            </div>

            <div x-show="searchLoading" class="text-center py-4">
                {% include "components/loading_spinner.html" %}
            </div>

            <div class="mb-4" x-show="!searchLoading && searchResults.length > 0">
                <div class="font-semibold mb-2">Search Results</div>
                <div class="table">
                    <table>
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th>Type</th>
                                <th>Table Type</th>
                                <th>Date</th>
                                <th>QPS</th>
                                <th>P95 Latency</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="test in searchResults" :key="test.test_id">
                                <tr>
                                    <td x-text="test.test_name"></td>
                                    <td>
                                        <img
                                            x-show="tableTypeIconSrc(test)"
                                            class="template-type-icon"
                                            :src="tableTypeIconSrc(test)"
                                            :alt="tableTypeLabel(test)"
                                            :title="tableTypeLabel(test)"
                                        >
                                    </td>
                                    <td x-text="tableTypeLabel(test) || test.table_type"></td>
                                    <td x-text="new Date(test.created_at).toLocaleDateString()"></td>
                                    <td x-text="Number(test.ops_per_sec || 0).toFixed(0)"></td>
                                    <td x-text="Number(test.p95_latency || 0).toFixed(2) + ' ms'"></td>
                                    <td>
                                        <button
                                            type="button"
                                            class="btn btn-sm"
                                            :class="isCompared(test.test_id) ? 'btn-secondary' : 'btn-primary'"
                                            @click="toggleCompare(test.test_id)"
                                            :disabled="!isCompared(test.test_id) && compareTests.length >= 2"
                                        >
                                            <span x-text="isCompared(test.test_id) ? 'Remove' : 'Add to compare'"></span>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </details>

    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div class="card-title card-title--compact mb-0">
                Compare
                (<span x-text="compareTests.length"></span>/2)
            </div>
            <div class="btn-group">
                <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    @click="clearCompare"
                    :disabled="compareTests.length === 0"
                >
                    Clear
                </button>
            </div>
        </div>

        <div x-show="compareError" class="alert alert-error mb-4">
            <strong>Compare error.</strong>
            <span x-text="compareError"></span>
        </div>

        <div x-show="compareTests.length > 0" class="mb-4">
            <div class="font-semibold mb-2">Selected for Comparison</div>
            <div class="flex flex-wrap gap-2">
                <template x-for="test in compareTests" :key="test.test_id">
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800">
                        <span x-text="test.test_name" class="mr-2"></span>
                        <button
                            type="button"
                            class="text-blue-600 hover:text-blue-800"
                            @click="toggleCompare(test.test_id)"
                            title="Remove from compare"
                        >&times;</button>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="compareTests.length < 2" class="alert alert-info">
            Select 2 tests (from search or from the table below) to compare high-level metrics.
        </div>

        <div x-show="compareTests.length === 2" class="mt-4">
            <div class="font-semibold mb-2">High-level Comparison</div>
            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <th x-text="test.test_name"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold">Table Type</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="test.table_type"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Warehouse Size</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td
                                    x-text="['POSTGRES', 'SNOWFLAKE_POSTGRES'].includes((test.table_type || '').toUpperCase()) ? '—' : test.warehouse_size"
                                ></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Concurrent Connections</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="test.concurrent_connections"></td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Operations / Second</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.ops_per_sec || 0).toFixed(0)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.ops_per_sec === Math.max(...compareTests.map(t => t.ops_per_sec)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.ops_per_sec === Math.max(...compareTests.map(t => t.ops_per_sec))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P50 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p50_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p50_latency === Math.min(...compareTests.map(t => t.p50_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p50_latency === Math.min(...compareTests.map(t => t.p50_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P95 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p95_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p95_latency === Math.min(...compareTests.map(t => t.p95_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p95_latency === Math.min(...compareTests.map(t => t.p95_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">P99 Latency (ms)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.p99_latency || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.p99_latency === Math.min(...compareTests.map(t => t.p99_latency)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.p99_latency === Math.min(...compareTests.map(t => t.p99_latency))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Error Rate (%)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td>
                                    <span x-text="Number(test.error_rate || 0).toFixed(2)"></span>
                                    <span
                                        class="ml-2 text-sm"
                                        :class="test.error_rate === Math.min(...compareTests.map(t => t.error_rate)) ? 'text-green-600 font-bold' : 'text-gray-500'"
                                        x-show="test.error_rate === Math.min(...compareTests.map(t => t.error_rate))"
                                    >
                                        ✓ Best
                                    </span>
                                </td>
                            </template>
                        </tr>
                        <tr>
                            <td class="font-semibold">Test Duration (s)</td>
                            <template x-for="test in compareTests" :key="test.test_id">
                                <td x-text="Number(test.duration || 0).toFixed(0)"></td>
                            </template>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="btn-group mt-4">
                <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    @click="openDeepCompare"
                >
                    Deep Compare
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <div class="card-title card-title--compact mb-0">Test Results</div>
            <div>
                <span class="text-sm text-gray-600">
                    Showing <span x-text="tests.length"></span> results
                </span>
            </div>
        </div>

        <div x-show="error" class="alert alert-error">
            <strong>Failed to load test results.</strong>
            <span x-text="error"></span>
            <div class="mt-2 text-sm">
                If this looks like a Snowflake connectivity issue, connect to VPN / allowlist your IP and refresh.
            </div>
        </div>

        <div class="table">
            <table>
                <thead>
                    <tr>
                        <th @click="sortBy('test_name')" class="cursor-pointer">
                            Test Name 
                            <span x-show="sortField === 'test_name'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th>Type</th>
                        <th @click="sortBy('table_type')" class="cursor-pointer">
                            Table Type
                            <span x-show="sortField === 'table_type'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th @click="sortBy('created_at')" class="cursor-pointer">
                            Date
                            <span x-show="sortField === 'created_at'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th @click="sortBy('ops_per_sec')" class="cursor-pointer">
                            QPS
                            <span x-show="sortField === 'ops_per_sec'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th @click="sortBy('p95_latency')" class="cursor-pointer">
                            P95 Latency
                            <span x-show="sortField === 'p95_latency'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                        </th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="test in sortedTests" :key="test.test_id">
                        <tr>
                            <td>
                                <a :href="dashboardUrl(test)" class="text-blue-600 hover:underline" x-text="test.test_name"></a>
                            </td>
                            <td>
                                <img
                                    x-show="tableTypeIconSrc(test)"
                                    class="template-type-icon"
                                    :src="tableTypeIconSrc(test)"
                                    :alt="tableTypeLabel(test)"
                                    :title="tableTypeLabel(test)"
                                >
                            </td>
                            <td x-text="tableTypeLabel(test) || test.table_type"></td>
                            <td x-text="new Date(test.created_at).toLocaleString()"></td>
                            <td x-text="test.ops_per_sec.toFixed(0)"></td>
                            <td x-text="test.p95_latency.toFixed(2) + ' ms'"></td>
                            <td>
                                <div class="flex flex-col gap-1">
                                    <span 
                                        class="status-badge"
                                        :class="(() => {
                                            const phase = test.phase ? test.phase.toUpperCase() : null;
                                            const status = test.status ? test.status.toUpperCase() : '';
                                            if (phase && status === 'RUNNING') {
                                                return {
                                                    'status-preparing': phase === 'PREPARING',
                                                    'status-warmup': phase === 'WARMUP' || phase === 'WARM-UP',
                                                    'status-running': phase === 'RUNNING',
                                                    'status-processing': phase === 'PROCESSING'
                                                };
                                            }
                                            return {
                                                'status-completed': status === 'COMPLETED',
                                                'status-running': status === 'RUNNING',
                                                'status-failed': status === 'FAILED',
                                                'status-paused': status === 'PAUSED',
                                                'status-cancelled': status === 'CANCELLED'
                                            };
                                        })()"
                                        x-text="test.phase && test.status === 'RUNNING' ? test.phase : test.status">
                                    </span>
                                    <template x-if="test.status && test.status.toUpperCase() === 'FAILED' && test.failure_reason">
                                        <span 
                                            class="text-xs text-red-600 max-w-[200px] truncate cursor-help"
                                            :title="test.failure_reason"
                                            x-text="test.failure_reason.length > 50 ? test.failure_reason.substring(0, 50) + '...' : test.failure_reason">
                                        </span>
                                    </template>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    <button 
                                        type="button" 
                                        class="btn btn-primary btn-sm"
                                        @click="viewTest(test)">
                                        View
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-secondary btn-sm"
                                        @click="toggleCompare(test.test_id)"
                                        :disabled="!isCompared(test.test_id) && compareTests.length >= 2"
                                    >
                                        <span x-text="isCompared(test.test_id) ? 'Remove' : 'Compare'"></span>
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-secondary btn-sm"
                                        @click="rerunTest(test.test_id)">
                                        Re-run
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-error btn-sm"
                                        @click="deleteTest(test.test_id)">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div x-show="!error && tests.length === 0" class="alert alert-info">
            No test results found. Run your first test to see results here.
        </div>

        <div class="flex justify-between items-center mt-4" x-show="totalPages > 1">
            <button 
                type="button" 
                class="btn btn-secondary"
                @click="previousPage"
                :disabled="currentPage === 1">
                Previous
            </button>
            <span class="text-sm text-gray-600">
                Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
            </span>
            <button 
                type="button" 
                class="btn btn-secondary"
                @click="nextPage"
                :disabled="currentPage === totalPages">
                Next
            </button>
        </div>
    </div>

</div>
{% endblock %}

{# testHistory() is defined in /static/js/history.js and loaded globally #}
