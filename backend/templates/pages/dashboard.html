{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Dashboard - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="dashboard({ mode: 'live' })" data-test-id="{{ test_id or '' }}">
    <div class="dashboard-top-grid">
        <div class="card" x-show="templateInfo">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <img
                        x-show="tableTypeIconSrc()"
                        class="template-type-icon"
                        :src="tableTypeIconSrc()"
                        :alt="tableTypeLabel()"
                        :title="tableTypeLabel()"
                        style="width: 24px; height: 24px;"
                    >
                    <div
                        class="card-title"
                        x-text="templateInfo ? (templateInfo.template_name || templateInfo.test_name || '') : ''"
                    ></div>
                </div>
                <a
                    x-show="templateInfo && templateInfo.template_id"
                    :href="templateInfo ? `/configure?template_id=${encodeURIComponent(templateInfo.template_id)}&mode=view` : '#'"
                    target="_blank"
                    rel="noopener"
                    title="View template"
                    style="color: var(--text-secondary); display: flex; align-items: center;"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
            </div>
            <div class="text-sm text-gray-600">
                <div class="mt-1">
                    <strong>Table:</strong>
                    <span x-text="templateInfo ? (templateInfo.table_full_name || '') : ''"></span>
                    (<span x-text="templateInfo ? (templateInfo.table_type || '') : ''"></span>)
                </div>
                <div class="mt-1" x-show="!isPostgresTable()">
                    <strong>Warehouse:</strong>
                    <span x-text="warehouseDisplay()"></span>
                </div>
                <div class="mt-1" x-show="isPostgresTable()">
                    <strong>Database:</strong>
                    <span>Postgres</span>
                </div>
                <div class="mt-1" x-show="isPostgresTable() && postgresPoolDisplay()">
                    <strong>Postgres:</strong>
                    <span x-text="postgresPoolDisplay()"></span>
                </div>
                <div class="mt-1" x-show="isPostgresTable() && postgresConnectionsDisplay()">
                    <strong>Postgres:</strong>
                    <span x-text="postgresConnectionsDisplay()"></span>
                </div>
                <div class="mt-1" x-show="loadModeDisplay()">
                    <strong>Load Mode:</strong>
                    <span x-text="loadModeDisplay()"></span>
                </div>
                <div class="mt-1" x-show="workloadDisplay()">
                    <strong>Workload Mix:</strong>
                    <span x-text="workloadDisplay()"></span>
                </div>
                <div class="mt-1" x-show="templateInfo && Number(templateInfo.duration_seconds || 0) > 0">
                    <strong>Duration:</strong>
                    <span x-text="templateInfo ? (templateInfo.duration_seconds ?? '') : ''"></span>s
                </div>
                <div class="mt-1" x-show="scalingSummary()">
                    <strong>Scaling:</strong>
                    <span x-text="scalingSummary()"></span>
                    <span x-show="boundsStatusText()">
                        • <span x-text="boundsStatusText()"></span>
                    </span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Test Control Panel</div>

            <div class="btn-group" style="justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 1rem;">
                <button
                    class="btn btn-success"
                    :disabled="(status || '').toUpperCase() !== 'PREPARED' && (status || '').toUpperCase() !== 'READY'"
                    @click="startTest()">
                    <span class="loading-spinner htmx-indicator"></span>
                    Start
                </button>
                <button
                    class="btn btn-error"
                    :disabled="(status || '').toUpperCase() !== 'RUNNING'"
                    @click="stopTest()">
                    Stop
                </button>
                </div>
                <button
                    class="btn btn-primary"
                    x-show="isFinalMetricsReady()"
                    @click="openRunAnalysis()">
                    Open run analysis
                </button>
            </div>

            <div x-show="hasTestStarted()">
                <div class="form-group">
                    <label class="form-label">Test Progress</label>
                    
                    <!-- Phase Pipeline -->
                    <div class="phase-pipeline">
                        <template x-for="(phaseName, idx) in phaseNames()" :key="phaseName">
                            <div class="phase-item">
                                <span 
                                    class="phase-badge"
                                    :class="phaseBadgeClassNew(phaseName)"
                                >
                                    <!-- Spinner for active untimed phases -->
                                    <span 
                                        class="phase-spinner"
                                        x-show="phaseState(phaseName) === 'current' && (phaseName === 'PREPARING' || phaseName === 'PROCESSING')"
                                    ></span>
                                    <!-- Checkmark for completed phases OR the COMPLETED phase when current -->
                                    <span 
                                        class="phase-checkmark"
                                        x-show="phaseState(phaseName) === 'completed' || (phaseName === 'COMPLETED' && phaseState(phaseName) === 'current')"
                                    >✓</span>
                                    <span x-text="completedPhaseDisplayName(phaseName)"></span>
                                </span>
                                <!-- Arrow between phases (not after last) -->
                                <span 
                                    class="phase-arrow"
                                    :class="{ 'phase-arrow--active': idx < currentPhaseIndex() }"
                                    x-show="idx < phaseNames().length - 1"
                                >→</span>
                            </div>
                        </template>
                    </div>

                    <!-- Phase Progress Bar (only for timed phases: WARMUP, RUNNING) -->
                    <div class="phase-progress-section" x-show="isTimedPhase()">
                        <div class="phase-progress-label" x-text="currentPhaseDisplayName()"></div>
                        <div class="phase-progress-bar">
                            <div 
                                class="phase-progress-bar-fill"
                                :class="phaseProgressBarClass()"
                                :style="`width: ${phaseProgressPercent()}%`"
                            ></div>
                        </div>
                        <div class="phase-progress-timing">
                            <span x-text="phaseTimingLabel()"></span>
                        </div>
                    </div>

                    <!-- Total Time Counter -->
                    <div class="total-time-display">
                        <span class="total-time-label">Total Time:</span>
                        <span class="total-time-value" x-text="`${Math.floor(elapsed)}s`"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% include "components/latency_sections.html" %}

    <div class="card" x-show="mode === 'live'">
        <div class="card-title">Workers</div>
        <div class="text-sm text-gray-600" style="margin-top: -0.25rem;">
            Live health and throughput from the controller. Click a worker to load per-worker snapshots.
        </div>

        <div
            x-show="!liveWorkers.length"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            Waiting for worker heartbeats...
        </div>

        <div class="worker-grid" x-show="liveWorkers.length" style="margin-top: 1rem;">
            <template x-for="worker in liveWorkers" :key="worker.key">
                <button
                    type="button"
                    class="worker-card"
                    :class="workerMetricsExpanded[worker.key] ? 'worker-card--expanded' : ''"
                    @click="toggleLiveWorker(worker)"
                >
                    <div class="worker-card__header">
                        <div class="worker-card__title">
                            <span class="worker-status-dot" :style="`background: ${workerHealthColor(worker)}`"></span>
                            <span x-text="workerLabel(worker)"></span>
                        </div>
                        <span class="worker-card__health" x-text="worker.health || 'UNKNOWN'"></span>
                    </div>
                    <div class="worker-card__metrics">
                        <div class="worker-card__metric">
                            <div class="worker-metric-label">QPS</div>
                            <div class="worker-metric-value" x-text="formatCompact(workerMetric(worker, 'qps') || 0)"></div>
                        </div>
                        <div class="worker-card__metric">
                            <div class="worker-metric-label">Errors</div>
                            <div class="worker-metric-value" x-text="formatCompact(workerMetric(worker, 'error_count') || 0)"></div>
                        </div>
                        <div class="worker-card__metric">
                            <div class="worker-metric-label">Active</div>
                            <div class="worker-metric-value" x-text="formatCompact(workerMetric(worker, 'active_connections') || 0)"></div>
                        </div>
                        <div class="worker-card__metric">
                            <div class="worker-metric-label">Heartbeat</div>
                            <div class="worker-metric-value" x-text="formatHeartbeatAge(worker)"></div>
                        </div>
                    </div>
                    <div class="worker-card__footer" x-text="worker.phase ? ('Phase: ' + worker.phase) : 'Phase: n/a'"></div>
                </button>
            </template>
        </div>
    </div>

    <div
        class="card"
        x-show="mode === 'live' && Object.values(workerMetricsExpanded).some(Boolean)"
    >
        <div class="card-title">Worker Details</div>
        <div class="text-sm text-gray-600" style="margin-top: -0.25rem;">
            Snapshot details pulled on demand from <code>WORKER_METRICS_SNAPSHOTS</code>.
        </div>

        <div x-show="workerMetricsError" class="alert alert-error" style="margin-top: 1rem;">
            <strong>Failed to load worker metrics.</strong>
            <span x-text="workerMetricsError"></span>
        </div>

        <div x-show="!workerMetricsError && workerMetricsLoading" style="margin-top: 1rem;">
            {% include "components/loading_spinner.html" %}
        </div>

        <template x-for="worker in workerMetricsWorkers" :key="'live-worker-' + worker.key">
            <div x-show="workerMetricsExpanded[worker.key]" x-cloak class="worker-detail-panel">
                <div class="worker-detail-header">
                    <div class="worker-detail-title">
                        <span class="worker-status-dot" :style="`background: ${workerHealthColor(worker)}`"></span>
                        <span x-text="workerLabel(worker)"></span>
                    </div>
                    <button
                        type="button"
                        class="btn btn-sm btn-secondary"
                        @click="toggleLiveWorker(worker)"
                    >
                        Hide
                    </button>
                </div>
                <div class="worker-detail-kpis">
                    <div class="worker-detail-kpi">
                        <div class="worker-detail-label">QPS</div>
                        <div class="worker-detail-value" x-text="formatCompact(worker.latest ? worker.latest.qps : 0)"></div>
                    </div>
                    <div class="worker-detail-kpi">
                        <div class="worker-detail-label">P95</div>
                        <div class="worker-detail-value" x-text="formatMsWithUnit(worker.latest ? worker.latest.p95_latency : 0)"></div>
                    </div>
                    <div class="worker-detail-kpi">
                        <div class="worker-detail-label">Errors</div>
                        <div class="worker-detail-value" x-text="formatCompact(worker.latest ? worker.latest.error_count : 0)"></div>
                    </div>
                    <div class="worker-detail-kpi">
                        <div class="worker-detail-label">Active</div>
                        <div class="worker-detail-value" x-text="formatCompact(worker.latest ? worker.latest.active_connections : 0)"></div>
                    </div>
                    <div class="worker-detail-kpi">
                        <div class="worker-detail-label">Target</div>
                        <div class="worker-detail-value" x-text="formatCompact(worker.latest ? worker.latest.target_connections : 0)"></div>
                    </div>
                </div>
                <div class="worker-detail-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Elapsed</th>
                                <th>P50</th>
                                <th>P99</th>
                                <th>Read</th>
                                <th>Write</th>
                                <th>Errors</th>
                                <th>Active</th>
                                <th>Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td x-text="formatSecondsTenths(worker.latest ? worker.latest.elapsed_seconds : 0) + 's'"></td>
                                <td x-text="formatMsWithUnit(worker.latest ? worker.latest.p50_latency : 0)"></td>
                                <td x-text="formatMsWithUnit(worker.latest ? worker.latest.p99_latency : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.read_count : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.write_count : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.error_count : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.active_connections : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.target_connections : 0)"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container" style="height: 220px; margin-top: 1rem;">
                    <canvas :id="'workerMetricsChart-' + worker.key"></canvas>
                </div>
            </div>
        </template>
    </div>
    
    <div class="card">
        <div class="card-title">Real-Time Metrics</div>
        <div class="chart-container">
            <canvas id="throughputChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Latency Distribution</div>
        <div class="chart-container">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Concurrent Queries</div>
        <div class="chart-container">
            <canvas id="concurrencyChart"></canvas>
        </div>
    </div>

    <div class="card" x-show="!['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())">
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <div class="card-title" style="margin-bottom: 0;">Snowflake Running Queries (Server)</div>
            <div style="display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <div style="font-weight: 600;">Breakdown:</div>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="sfRunningBreakdown === 'read_write' ? 'btn-primary' : 'btn-secondary'"
                    @click="setSfRunningBreakdown('read_write')"
                >
                    Read / Write
                </button>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="sfRunningBreakdown === 'by_kind' ? 'btn-primary' : 'btn-secondary'"
                    @click="setSfRunningBreakdown('by_kind')"
                >
                    Point / Range / Insert / Update
                </button>
            </div>
        </div>
        <div style="color: #6b7280; margin-top: 0.5rem;">
            Sampled every ~5 seconds from <code>INFORMATION_SCHEMA.QUERY_HISTORY_BY_WAREHOUSE</code> filtered by per-test <code>QUERY_TAG</code>.
            "Total" is the sum of benchmark statements (best-effort). If kind tagging is unavailable for a run, the chart falls back to Snowflake's per-test Running total.
        </div>
        <div class="chart-container" style="margin-top: 0.75rem;">
            <canvas id="sfRunningChart"></canvas>
        </div>
    </div>

    <div class="card" x-show="!['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())">
        <div class="card-title">MCW Active Clusters (real-time)</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Sampled every ~5 seconds from <code>SHOW WAREHOUSES</code>. Shows started clusters (MCW nodes).
        </div>
        <div class="chart-container" style="margin-top: 0.75rem;">
            <canvas id="mcwLiveChart"></canvas>
        </div>
    </div>

    <div class="card" x-show="metrics.resources_available">
        <div class="card-title">Resources (host + process)</div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">
                    <span>CPU (host)</span>
                    <span class="info-icon" title="Host CPU usage (cgroup-aware when limits are present).">i</span>
                </div>
                <div class="metric-value" x-text="formatPctValue(metrics.host_cpu_percent != null ? metrics.host_cpu_percent : metrics.cpu_percent)"></div>
                <div class="metric-change" style="display: flex; flex-direction: column; gap: 2px;">
                    <template x-if="metrics.cgroup_cpu_percent != null && metrics.cgroup_cpu_quota_cores != null">
                        <span x-text="'Cgroup: ' + formatPctValue(metrics.cgroup_cpu_percent) + ' of ' + formatCompact(metrics.cgroup_cpu_quota_cores) + ' cores'"></span>
                    </template>
                    <span x-text="'Process: ' + formatPctValue(metrics.cpu_percent)"></span>
                </div>
                <div style="height: 60px; margin-top: 0.5rem;">
                    <canvas id="resourcesCpuSparkline"></canvas>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">
                    <span>Memory (host)</span>
                    <span class="info-icon" title="Host memory usage (cgroup-aware when limits are present).">i</span>
                </div>
                <div
                    class="metric-value"
                    x-text="metrics.host_memory_total_mb != null ? (formatCompact(metrics.host_memory_mb || 0) + ' / ' + formatCompact(metrics.host_memory_total_mb) + ' MB') : (formatCompact(metrics.memory_mb) + ' MB')"
                ></div>
                <div class="metric-change" style="display: flex; flex-direction: column; gap: 2px;">
                    <template x-if="metrics.host_memory_percent != null">
                        <span x-text="'Host: ' + formatPctValue(metrics.host_memory_percent)"></span>
                    </template>
                    <template x-if="metrics.cgroup_memory_mb != null && metrics.cgroup_memory_limit_mb != null">
                        <span x-text="'Cgroup: ' + formatCompact(metrics.cgroup_memory_mb) + ' / ' + formatCompact(metrics.cgroup_memory_limit_mb) + ' MB (' + formatPctValue(metrics.cgroup_memory_percent) + ')'"></span>
                    </template>
                    <span x-text="'Process: ' + formatCompact(metrics.memory_mb) + ' MB'"></span>
                </div>
                <div style="height: 60px; margin-top: 0.5rem;">
                    <canvas id="resourcesMemSparkline"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Run Logs</div>

        <div
            class="form-group"
            x-show="logTargets && logTargets.length"
            style="margin-bottom: 0.75rem;"
        >
            <label class="form-label">Source</label>
            <select class="form-select" x-model="logSelectedTargetId" @change="onLogTargetChange()">
                <template x-for="target in logTargets" :key="target.target_id || target.test_id">
                    <option
                        :value="target.target_id || target.test_id"
                        x-text="target.label || target.worker_id || target.test_id"
                    ></option>
                </template>
            </select>
        </div>

        <div class="log-controls">
            <div class="log-control">
                <label class="form-label">Level</label>
                <select class="form-select" x-model="logLevelFilter">
                    <template x-for="opt in logLevelOptions()" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                    </template>
                </select>
            </div>
            <div class="log-control log-control-toggle">
                <label class="form-label">
                    <input type="checkbox" class="form-checkbox" x-model="logVerboseMode">
                    Verbose mode
                </label>
            </div>
        </div>

        <div
            class="alert alert-error"
            x-show="(status || '').toUpperCase() === 'FAILED'"
        >
            Test failed. See logs below.
        </div>

        <div class="log-output">
            <template x-if="filteredLogs().length === 0">
                <div class="log-empty">No logs yet.</div>
            </template>
            <template x-for="log in filteredLogs()" :key="log.log_id">
                <div class="log-line">
                    <span class="log-ts" x-text="formatLogTimestamp(log.timestamp)"></span>
                    <span class="log-level" :class="logLineLevelClass(log.level)" x-text="(log.level || 'INFO').toUpperCase()"></span>
                    <button
                        type="button"
                        :class="logWorkerBadgeClass(log.worker_id)"
                        @click="setLogWorkerFilter(_normalizeWorkerId(log.worker_id))"
                        x-text="_normalizeWorkerId(log.worker_id)"
                    ></button>
                    <span class="log-logger" x-text="formatLogLogger(log.logger)"></span>
                    <span class="log-sep">-</span>
                    <span class="log-message" x-text="log.message"></span>
                    <template x-if="log.exception">
                        <pre class="log-exception" x-text="log.exception"></pre>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}
