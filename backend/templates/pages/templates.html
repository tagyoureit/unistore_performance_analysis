{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Templates - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="templatesManager()">
    <div class="card">
        <div class="card-title">Test Configuration Templates</div>
        <p>Manage reusable test templates. All tests run from templates.</p>
        
        <div class="flex justify-between items-center mt-4">
            <div class="form-group mb-0" style="flex: 1; max-width: 400px;">
                <input type="text" 
                       class="form-input" 
                       x-model="searchQuery" 
                       placeholder="Search templates..."
                       @input="filterTemplates">
            </div>
            
            <div class="btn-group" style="margin-bottom: 0; align-items: center;">
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="viewMode === 'table' ? 'btn-primary' : 'btn-secondary'"
                    @click="setViewMode('table')"
                    title="Table view"
                >
                    Table
                </button>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="viewMode === 'cards' ? 'btn-primary' : 'btn-secondary'"
                    @click="setViewMode('cards')"
                    title="Card view"
                >
                    Cards
                </button>
                <button class="btn btn-primary" @click="createNewTemplate">
                    <span>+ New Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div x-show="!loading && error" class="alert alert-error">
        <strong>Failed to load templates.</strong>
        <span x-text="error"></span>
        <div class="mt-2 text-sm">
            If this looks like a Snowflake connectivity issue, connect to VPN / allowlist your IP and refresh.
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-8">
        <div class="loading-spinner" style="display: inline-block;"></div>
        <p class="mt-2">Loading templates...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && !error && filteredTemplates.length === 0" class="card text-center">
        <div class="py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium">No templates found</h3>
            <p class="mt-1 text-sm text-gray-500" x-show="searchQuery">
                No templates match "<span x-text="searchQuery"></span>"
            </p>
            <p class="mt-1 text-sm text-gray-500" x-show="!searchQuery">
                Get started by creating your first template
            </p>
            <div class="mt-6">
                <button class="btn btn-primary" @click="createNewTemplate">
                    <span>+ Create Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Templates List -->
    <div x-show="!loading && !error && filteredTemplates.length > 0">
        <!-- Table view (dense) -->
        <div x-show="viewMode === 'table'" class="card templates-table-card">
            <div class="table templates-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 26%;">Name</th>
                            <th style="width: 7%;">Type</th>
                            <th style="width: 23%;">Table</th>
                            <th style="width: 10%;">Workload</th>
                            <th style="width: 8%;">Duration</th>
                            <th style="width: 12%;">Load</th>
                            <th style="width: 6%;">Used</th>
                            <th style="width: 18%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="template in filteredTemplates" :key="template.template_id">
                            <tr>
                                <td>
                                    <div class="templates-name" x-text="template.template_name"></div>
                                    <div class="templates-desc" x-text="template.description || 'No description'"></div>
                                </td>
                                <td>
                                    <img
                                        x-show="tableTypeIconSrc(template)"
                                        class="template-type-icon"
                                        :src="tableTypeIconSrc(template)"
                                        :alt="tableTypeLabel(template)"
                                        :title="tableTypeLabel(template)"
                                    >
                                </td>
                                <td class="templates-mono" x-text="tableFqn(template)"></td>
                                <td x-text="deriveWorkloadLabel(template.config)"></td>
                                <td
                                    x-text="(template.config?.load_mode === 'FIND_MAX_CONCURRENCY') ? '—' : ((template.config?.duration || '') + 's')"
                                ></td>
                                <td>
                                    <div>
                                        <span x-text="(template.config?.load_mode === 'QPS') ? 'Target QPS' : ((template.config?.load_mode === 'FIND_MAX_CONCURRENCY') ? 'Find Max' : 'Fixed Workers')"></span>
                                        <span x-show="(template.config?.load_mode || 'CONCURRENCY') === 'CONCURRENCY'">
                                            • <span x-text="template.config?.concurrent_connections"></span>
                                        </span>
                                        <span x-show="template.config?.load_mode === 'QPS'">
                                            • <span x-text="template.config?.target_qps"></span>
                                        </span>
                                        <span x-show="template.config?.load_mode === 'FIND_MAX_CONCURRENCY'">
                                            • Start: <span x-text="template.config?.start_concurrency || 5"></span>
                                            +<span x-text="template.config?.concurrency_increment || 10"></span>
                                        </span>
                                    </div>
                                </td>
                                <td x-text="template.usage_count || 0"></td>
                                <td>
                                    <div class="templates-actions">
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            x-show="template.usage_count === 0"
                                            @click="editTemplate(template)"
                                            title="Edit template"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            x-show="template.usage_count > 0"
                                            @click="viewTemplateDetails(template)"
                                            title="View template details (read-only)"
                                        >
                                            View
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-danger btn-sm"
                                            @click="deleteTemplate(template)"
                                            title="Delete template and all results"
                                        >
                                            Delete
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-primary btn-sm"
                                            @click="prepareTest(template)"
                                        >
                                            Prepare
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            @click="duplicateTemplate(template)"
                                            title="Copy this template"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card view (legacy) -->
        <div
            x-show="viewMode === 'cards'"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"
        >
            <template x-for="template in filteredTemplates" :key="template.template_id">
                <div class="card hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="templates-card-title">
                                <img
                                    x-show="tableTypeIconSrc(template)"
                                    class="template-type-icon"
                                    :src="tableTypeIconSrc(template)"
                                    :alt="tableTypeLabel(template)"
                                    :title="tableTypeLabel(template)"
                                >
                                <h3 class="text-lg font-semibold" x-text="template.template_name"></h3>
                            </div>
                            <span x-show="template.usage_count > 0" class="text-xs text-gray-500">
                                Used <span x-text="template.usage_count"></span> time(s)
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary btn-sm" 
                                    x-show="template.usage_count === 0"
                                    @click="editTemplate(template)"
                                    title="Edit template">
                                Edit
                            </button>
                            <button class="btn btn-secondary btn-sm"
                                    x-show="template.usage_count > 0"
                                    @click="viewTemplateDetails(template)"
                                    title="View template details (read-only)">
                                View details
                            </button>
                            <button class="btn btn-danger btn-sm" 
                                    @click="deleteTemplate(template)"
                                    title="Delete template and all results">
                                Delete
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-3" x-text="template.description || 'No description'"></p>
                    
                    <div class="text-xs text-gray-500 space-y-1">
                        <div>
                            <strong>Table:</strong> 
                            <span x-text="tableFqn(template)"></span>
                        </div>
                        <div>
                            <strong>Workload:</strong> 
                            <span x-text="deriveWorkloadLabel(template.config)"></span>
                        </div>
                        <div>
                            <strong>Duration:</strong>
                            <span
                                x-text="template.config?.load_mode === 'FIND_MAX_CONCURRENCY' ? '—' : (template.config?.duration + 's')"
                            ></span>
                        </div>
                        <div>
                            <strong>Load Mode:</strong> 
                            <span x-text="(template.config?.load_mode === 'QPS') ? 'Target throughput (QPS)' : ((template.config?.load_mode === 'FIND_MAX_CONCURRENCY') ? 'Find max (step-load)' : 'Fixed workers (closed model)')"></span>
                        </div>
                        <div x-show="(template.config?.load_mode || 'CONCURRENCY') === 'CONCURRENCY'">
                        <strong>Workers:</strong> 
                            <span x-text="template.config?.concurrent_connections"></span>
                        </div>
                        <div x-show="template.config?.load_mode === 'QPS'">
                        <strong>Target:</strong>
                        <span x-text="'QPS (ops/sec)'"></span>
                        = <span x-text="template.config?.target_qps"></span>
                        <div class="mt-1">
                            <strong>Workers:</strong>
                            <span x-text="(template.config?.min_concurrency ?? '') + '-' + (template.config?.concurrent_connections ?? '')"></span>
                        </div>
                        </div>
                        <div x-show="template.config?.load_mode === 'FIND_MAX_CONCURRENCY'">
                        <strong>Find Max (step-load):</strong>
                        <div class="mt-1">
                            Start: <span x-text="template.config?.start_concurrency ?? 5"></span>,
                            Increment: +<span x-text="template.config?.concurrency_increment ?? 10"></span>,
                            Step: <span x-text="template.config?.step_duration_seconds ?? 30"></span>s
                        </div>
                        <div class="mt-1">
                            Max workers: <span x-text="template.config?.concurrent_connections"></span>
                        </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-4 pt-3 border-t border-gray-200">
                        <button class="btn btn-primary flex-1" 
                                @click="prepareTest(template)">
                            Prepare Test
                        </button>
                        <button class="btn btn-secondary" 
                                @click="duplicateTemplate(template)"
                                title="Copy this template">
                            Copy
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}
