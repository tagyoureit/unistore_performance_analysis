{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Templates - FlakeBench{% endblock %}

{% block content %}
<div x-data="templatesManager()">
    <div class="card">
        <div class="card-title">Test Configuration Templates</div>
        <p>Manage reusable test templates. All tests run from templates.</p>
        
        <div class="flex justify-between items-center mt-4">
            <div class="flex gap-3 flex-1 max-w-2xl items-center">
                <div class="form-group mb-0" style="min-width: 140px;">
                    <select class="form-select" x-model="typeFilter" @change="filterTemplates">
                        <option value="">All Types</option>
                        <option value="STANDARD">Standard</option>
                        <option value="HYBRID">Hybrid</option>
                        <option value="INTERACTIVE">Interactive</option>
                        <option value="VIEW">View</option>
                        <option value="POSTGRES">Postgres</option>
                    </select>
                </div>
                <div class="form-group mb-0 flex-1">
                    <input type="text" 
                           class="form-input" 
                           x-model="searchQuery" 
                           placeholder="Search templates..."
                           @input="filterTemplates">
                </div>
            </div>
            
            <div class="btn-group mb-0 items-center">
                <button class="btn btn-primary" @click="createNewTemplate">
                    <span>+ New Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div x-show="!loading && error" class="alert alert-error">
        <strong>Failed to load templates.</strong>
        <span x-text="error"></span>
        <div class="mt-2 text-sm">
            If this looks like a Snowflake connectivity issue, connect to VPN / allowlist your IP and refresh.
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-8">
        <div class="loading-spinner" style="display: inline-block;"></div>
        <p class="mt-2">Loading templates...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && !error && filteredTemplates.length === 0" class="card text-center">
        <div class="py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium">No templates found</h3>
            <p class="mt-1 text-sm text-gray-500" x-show="searchQuery">
                No templates match "<span x-text="searchQuery"></span>"
            </p>
            <p class="mt-1 text-sm text-gray-500" x-show="!searchQuery">
                Get started by creating your first template
            </p>
            <div class="mt-6">
                <button class="btn btn-primary" @click="createNewTemplate">
                    <span>+ Create Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Templates List -->
    <div x-show="!loading && !error && filteredTemplates.length > 0">
        <!-- Table view (dense) -->
        <div class="card templates-table-card">
            <div class="table templates-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 20%;">Name</th>
                            <th style="width: 5%;">Type</th>
                            <th style="width: 16%;">Table</th>
                            <th style="width: 11%;">Size</th>
                            <th style="width: 11%;">Load Mode</th>
                            <th style="width: 12%;">Workload</th>
                            <th style="width: 9%;">Duration</th>
                            <th style="width: 12%;">Scaling</th>
                            <th style="width: 4%;">Used</th>
                            <th style="width: 11%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="template in filteredTemplates" :key="template.template_id">
                            <tr>
                                <td>
                                    <div class="templates-name" x-text="template.template_name"></div>
                                    <div class="templates-desc" x-text="template.description || 'No description'"></div>
                                </td>
                                <td>
                                    <img
                                        x-show="tableTypeIconSrc(template)"
                                        class="template-type-icon"
                                        :src="tableTypeIconSrc(template)"
                                        :alt="tableTypeLabel(template)"
                                        :title="tableTypeLabel(template)"
                                    >
                                </td>
                                <td class="templates-mono" x-text="tableFqn(template)"></td>
                                <td x-html="warehouseDisplay(template)"></td>
                                <td x-html="loadModeDisplay(template.config)"></td>
                                <td x-html="workloadMixDisplay(template.config)"></td>
                                <td x-html="durationDisplay(template.config)"></td>
                                <td x-html="scalingDisplay(template.config)"></td>
                                <td x-text="template.usage_count || 0"></td>
                                <td>
                                    <div class="templates-actions">
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            x-show="template.usage_count === 0"
                                            :disabled="isTemplateActionInProgress(template.template_id)"
                                            @click="editTemplate(template)"
                                            title="Edit template"
                                        >
                                            <span class="loading-spinner" x-show="editingTemplateId === template.template_id"></span>
                                            <span x-text="editingTemplateId === template.template_id ? 'Loading…' : 'Edit'"></span>
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            x-show="template.usage_count > 0"
                                            :disabled="isTemplateActionInProgress(template.template_id)"
                                            @click="viewTemplateDetails(template)"
                                            title="View template details (read-only)"
                                        >
                                            <span class="loading-spinner" x-show="viewingTemplateId === template.template_id"></span>
                                            <span x-text="viewingTemplateId === template.template_id ? 'Loading…' : 'View'"></span>
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-danger btn-sm"
                                            :disabled="isTemplateActionInProgress(template.template_id)"
                                            @click="deleteTemplate(template)"
                                            title="Delete template and all results"
                                        >
                                            <span class="loading-spinner" x-show="deletingTemplateId === template.template_id"></span>
                                            <span x-text="deletingTemplateId === template.template_id ? 'Deleting…' : 'Delete'"></span>
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-primary btn-sm"
                                            :disabled="isTemplateActionInProgress(template.template_id)"
                                            @click="prepareTest(template)"
                                        >
                                            <span class="loading-spinner" x-show="preparingTemplateId === template.template_id"></span>
                                            <span x-text="preparingTemplateId === template.template_id ? 'Loading…' : 'Run'"></span>
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-secondary btn-sm"
                                            :disabled="isTemplateActionInProgress(template.template_id)"
                                            @click="duplicateTemplate(template)"
                                            title="Copy this template"
                                        >
                                            <span class="loading-spinner" x-show="copyingTemplateId === template.template_id"></span>
                                            <span x-text="copyingTemplateId === template.template_id ? 'Copying…' : 'Copy'"></span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}
