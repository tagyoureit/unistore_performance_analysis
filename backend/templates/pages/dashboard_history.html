{% if is_htmx %}
{% extends "partials/content_only.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}Dashboard History - Unistore Benchmark{% endblock %}

{% block content %}
<div x-data="dashboard({ mode: 'history' })" data-test-id="{{ test_id or '' }}"
     x-init="$nextTick(() => initFloatingToolbar())"
>
    <div class="dashboard-top-grid">
        <div class="card" x-show="templateInfo">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <img
                        x-show="tableTypeIconSrc()"
                        class="template-type-icon"
                        :src="tableTypeIconSrc()"
                        :alt="tableTypeLabel()"
                        :title="tableTypeLabel()"
                        style="width: 24px; height: 24px;"
                    >
                    <div
                        class="card-title"
                        x-text="templateInfo ? (templateInfo.template_name || templateInfo.test_name || '') : ''"
                    ></div>
                </div>
                <a
                    x-show="templateInfo && templateInfo.template_id"
                    :href="templateInfo ? `/configure?template_id=${encodeURIComponent(templateInfo.template_id)}&mode=view` : '#'"
                    target="_blank"
                    rel="noopener"
                    title="View template"
                    style="color: var(--text-secondary); display: flex; align-items: center;"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
            </div>
            <div class="text-sm text-gray-600">
                <div class="mt-1">
                    <strong>Table:</strong>
                    <span x-text="templateInfo ? (templateInfo.table_full_name || '') : ''"></span>
                    (<span x-text="templateInfo ? (templateInfo.table_type || '') : ''"></span>)
                </div>
                <div class="mt-1" x-show="!isPostgresTable()">
                    <strong>Warehouse:</strong>
                    <span x-text="warehouseDisplay()"></span>
                </div>
                <div class="mt-1" x-show="isPostgresTable()">
                    <strong>Database:</strong>
                    <span>Postgres</span>
                </div>
                <div class="mt-1" x-show="isPostgresTable() && postgresPoolDisplay()">
                    <strong>Postgres:</strong>
                    <span x-text="postgresPoolDisplay()"></span>
                </div>
                <div class="mt-1" x-show="isPostgresTable() && postgresConnectionsDisplay()">
                    <strong>Postgres:</strong>
                    <span x-text="postgresConnectionsDisplay()"></span>
                </div>
                <div class="mt-1" x-show="loadModeDisplay()">
                    <strong>Load Mode:</strong>
                    <span x-text="loadModeDisplay()"></span>
                </div>
                <div class="mt-1" x-show="workloadDisplay()">
                    <strong>Workload Mix:</strong>
                    <span x-text="workloadDisplay()"></span>
                </div>
                <div class="mt-1" x-show="templateInfo && Number(templateInfo.duration_seconds || 0) > 0">
                    <strong>Duration:</strong>
                    <span x-text="templateInfo && templateInfo.duration_seconds != null ? formatSecondsTenths(templateInfo.duration_seconds) : ''"></span>s
                </div>
                <div class="mt-1" x-show="scalingSummary()">
                    <strong>Scaling:</strong>
                    <span x-text="scalingSummary()"></span>
                </div>
                <div class="mt-1" x-show="boundsCompletionReason()">
                    <strong>Bounds:</strong>
                    <span x-text="boundsCompletionReason()"></span>
                </div>
                <div class="mt-1">
                    <strong>Status:</strong>
                    <span
                        class="status-badge"
                        :class="phaseBadgeClass()"
                        x-text="phaseLabel() || (templateInfo ? (templateInfo.status || '') : '')"
                    ></span>
                </div>
                <div class="mt-1" x-show="templateInfo && templateInfo.query_tag">
                    <strong>Query Tag:</strong>
                    <code
                        style="font-size: 0.75rem; background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; word-break: break-all;"
                        x-text="templateInfo ? (templateInfo.query_tag || '') : ''"
                    ></code>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">History View</div>
            <div style="color: #6b7280;">
                Read-only analysis dashboard. For realtime execution and controls, use the live dashboard.
            </div>
            <div style="margin-top: 0.75rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <a 
                        class="btn btn-primary" 
                        :href="testId ? `/dashboard/${testId}` : '/dashboard'"
                        :class="{ 'btn-disabled': !templateInfo || templateInfo.status !== 'RUNNING' }"
                        :style="(!templateInfo || templateInfo.status !== 'RUNNING') ? 'pointer-events: none; opacity: 0.5;' : ''"
                    >
                        Open Live Dashboard
                    </a>
                    <button
                        type="button"
                        class="btn btn-secondary"
                        @click="rerunTest(testId)"
                        :disabled="!testId"
                    >
                        Re-run
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating View Controls Toolbar -->
    <div
        class="floating-toolbar"
        :class="{ 'hidden': !floatingToolbarVisible }"
        x-show="latencyInView || chartsInView"
        x-cloak
    >
        <div class="floating-toolbar-group" x-show="latencyInView">
            <span class="floating-toolbar-label">Latency</span>
            <button
                type="button"
                class="btn btn-sm"
                :class="latencyView === 'sf_execution' ? 'btn-primary' : 'btn-secondary'"
                @click="setLatencyView('sf_execution')"
                :disabled="!sfLatencyAvailable()"
            >
                SQL (Snowflake)
            </button>
            <button
                type="button"
                class="btn btn-sm"
                :class="latencyView === 'end_to_end' ? 'btn-primary' : 'btn-secondary'"
                @click="setLatencyView('end_to_end')"
            >
                End-to-end
            </button>
        </div>

        <div class="floating-toolbar-divider" x-show="latencyInView && chartsInView && metricsWarmupEndElapsed > 0"></div>

        <div class="floating-toolbar-group" x-show="chartsInView && metricsWarmupEndElapsed != null && metricsWarmupEndElapsed > 0">
            <span class="floating-toolbar-label">Charts</span>
            <button
                type="button"
                class="btn btn-sm"
                :class="showWarmup ? 'btn-warning' : 'btn-secondary'"
                @click="toggleShowWarmup()"
            >
                <span x-text="showWarmup ? 'Hide Warmup' : 'Show Warmup'"></span>
            </button>
            <span class="floating-toolbar-indicator" :class="{ 'active': showWarmup }">
                <span x-text="showWarmup ? 'Showing warmup' : 'Measurement only'"></span>
            </span>
        </div>
    </div>

    <!-- Enrichment Status Alert (shows if enrichment failed) -->
    <div
        class="alert alert-warning"
        style="margin-bottom: 1rem;"
        x-show="templateInfo && templateInfo.enrichment_status === 'FAILED'"
        x-cloak
    >
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
            <div>
                <strong>Post-processing incomplete:</strong>
                <span x-text="templateInfo?.enrichment_error || 'Enrichment failed'"></span>
                <br>
                <small style="color: var(--text-muted);">
                    Test results are preserved. You can retry enrichment to get Snowflake timing details (cluster info, queue times, etc.).
                </small>
            </div>
            <button
                type="button"
                class="btn btn-primary"
                style="white-space: nowrap;"
                @click="retryEnrichment()"
                :disabled="enrichmentRetrying"
            >
                <span x-show="enrichmentRetrying" class="ai-btn-spinner"></span>
                <span x-text="enrichmentRetrying ? 'Retrying...' : 'Retry Enrichment'"></span>
            </button>
        </div>
    </div>

    <!-- Enrichment Progress Alert (shows if enrichment is pending/in-progress) -->
    <div
        class="alert alert-info"
        style="margin-bottom: 1rem;"
        x-show="templateInfo && templateInfo.enrichment_status === 'PENDING' && enrichmentProgress"
        x-cloak
        x-init="$watch('templateInfo', () => { if (templateInfo?.enrichment_status === 'PENDING') startEnrichmentPolling(); })"
    >
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="ai-btn-spinner" style="width: 20px; height: 20px;"></div>
            <div style="flex: 1;">
                <strong>Post-processing in progress...</strong>
                <template x-if="enrichmentProgress && enrichmentProgress.total_queries > 0">
                    <span>
                        (<span x-text="enrichmentProgress.enriched_queries.toLocaleString()"></span> / 
                        <span x-text="enrichmentProgress.total_queries.toLocaleString()"></span> queries enriched, 
                        <span x-text="enrichmentProgress.enrichment_ratio_pct"></span>%)
                    </span>
                </template>
                <br>
                <small style="color: var(--text-muted);">
                    Fetching Snowflake timing details from QUERY_HISTORY. This may take several minutes for high-QPS tests.
                </small>
            </div>
        </div>
    </div>

    {% include "components/latency_sections.html" %}

    <div class="ai-analysis-card" x-show="!aiAnalysisModal" x-cloak>
        <div class="ai-analysis-card-content">
            <div class="ai-analysis-card-icon">✦</div>
            <div class="ai-analysis-card-text">
                <div class="ai-analysis-card-title">AI Analysis</div>
                <div class="ai-analysis-card-desc">Get AI-powered insights and recommendations for this benchmark</div>
            </div>
            <button
                type="button"
                class="btn btn-primary ai-analysis-card-btn"
                @click="openAiAnalysis()"
                :disabled="!testId || !isTerminalStatus(templateInfo?.status) || aiAnalysisLoading"
            >
                <span x-show="aiAnalysisLoading" class="ai-btn-spinner"></span>
                <span x-text="aiAnalysisLoading ? 'Analyzing...' : 'Analyze'"></span>
            </button>
        </div>
    </div>

    <div
        x-show="aiAnalysisModal"
        x-cloak
        class="ai-analysis-panel"
        @keydown.escape.window="closeAiAnalysis()"
    >
        <div class="ai-analysis-header">
            <h2>AI Analysis</h2>
            <button
                type="button"
                class="ai-analysis-close"
                @click="closeAiAnalysis()"
            >
                &times;
            </button>
        </div>

        <div class="ai-analysis-body">
            <div x-show="aiAnalysisLoading" class="ai-analysis-loading">
                <div class="ai-analysis-spinner"></div>
                <div class="ai-analysis-loading-text">Generating AI analysis...</div>
            </div>

            <div x-show="aiAnalysisError" class="alert alert-error" style="margin-bottom: 1rem;">
                <span x-text="aiAnalysisError"></span>
            </div>

            <div x-show="!aiAnalysisLoading && aiAnalysis">
                <div
                    class="analysis-content"
                    x-html="formatMarkdown(aiAnalysis?.analysis)"
                ></div>

                <div class="ai-analysis-chat-section">
                    <h3 class="ai-analysis-chat-title">Chat with AI</h3>
                    
                    <div
                        x-ref="chatContainer"
                        class="ai-analysis-chat-container"
                    >
                        <template x-for="(msg, idx) in chatHistory" :key="idx">
                            <div :style="msg.role === 'user' ? 'text-align: right; margin-bottom: 0.75rem;' : 'text-align: left; margin-bottom: 0.75rem;'">
                                <div
                                    :style="msg.role === 'user' 
                                        ? 'display: inline-block; background: #3b82f6; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 80%; text-align: left;'
                                        : 'display: inline-block; background: #e5e7eb; color: #1f2937; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 80%; text-align: left;'"
                                    x-html="msg.role === 'user' ? msg.content : formatMarkdown(msg.content)"
                                ></div>
                            </div>
                        </template>
                        <div x-show="chatLoading" style="text-align: left; margin-bottom: 0.75rem;">
                            <div style="display: inline-block; background: #e5e7eb; color: #6b7280; padding: 0.5rem 0.75rem; border-radius: 0.5rem;">
                                Thinking...
                            </div>
                        </div>
                    </div>

                    <form @submit.prevent="sendChatMessage()" class="ai-analysis-chat-form">
                        <input
                            type="text"
                            x-model="chatMessage"
                            placeholder="Ask a follow-up question..."
                            class="ai-analysis-chat-input"
                            :disabled="chatLoading"
                        />
                        <button
                            type="submit"
                            class="btn btn-primary"
                            :disabled="!chatMessage.trim() || chatLoading"
                        >
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card" x-show="hasStepHistory()">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
            <div class="card-title">Find Max (step-load) - Step History</div>
            <div x-show="hasMultiWorkerStepHistory()" style="display: flex; align-items: center; gap: 0.5rem;">
                <label style="font-size: 0.875rem; color: #6b7280;">View worker:</label>
                <select 
                    x-model="selectedStepHistoryWorker"
                    style="padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;"
                >
                    <template x-for="opt in stepHistoryWorkerOptions()" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                    </template>
                </select>
            </div>
        </div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Step-by-step progression showing how worker count was scaled until degradation was detected.
        </div>

        <div style="margin-top: 1rem;">
            <div class="metrics-grid" style="margin-bottom: 1rem;">
                <div class="metric-card">
                    <div class="metric-label" x-text="stepHistorySummary()?.is_aggregate ? 'Best Concurrency (per worker)' : 'Best Concurrency'"></div>
                    <div class="metric-value" x-text="formatInt(stepHistorySummary()?.best_concurrency)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" x-text="stepHistorySummary()?.is_aggregate ? 'Total QPS (all workers)' : 'Best QPS'"></div>
                    <div class="metric-value" x-text="formatMs(stepHistorySummary()?.best_qps)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" x-text="stepHistorySummary()?.is_aggregate ? 'Max Baseline P95' : 'Baseline P95'"></div>
                    <div class="metric-value" x-text="formatMs(stepHistorySummary()?.baseline_p95_ms) + ' ms'"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Steps</div>
                    <div class="metric-value" x-text="formatInt(stepHistorySummary()?.total_steps)"></div>
                </div>
            </div>

            <div x-show="stepHistorySummary()?.final_reason" style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.375rem; border-left: 4px solid #f59e0b;">
                <strong>Conclusion:</strong> <span x-text="stepHistorySummary()?.final_reason"></span>
            </div>

            <div 
                style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;"
                @click="toggleStepHistory()"
            >
                <span 
                    style="display: inline-block; width: 1rem; text-align: center; transition: transform 0.15s;"
                    :style="stepHistoryExpanded ? 'transform: rotate(90deg);' : ''"
                >▶</span>
                <span style="font-weight: 600;">Step-by-step details</span>
                <span style="color: #6b7280; font-size: 0.875rem;" x-text="stepHistoryExpanded ? '(click to collapse)' : '(click to expand)'"></span>
            </div>

            <div x-show="stepHistoryExpanded" class="table" style="margin-top: 0.5rem;">
                <table>
                    <thead>
                        <tr>
                            <th class="text-right">Step</th>
                            <th class="text-right">Workers</th>
                            <th class="text-right" x-show="stepHistorySummary()?.is_aggregate">Total Workers</th>
                            <th class="text-right" x-show="stepHistorySummary()?.is_aggregate">Active Workers</th>
                            <th class="text-right">QPS</th>
                            <th class="text-right">P95 (ms)</th>
                            <th class="text-right">P95% (Δ)</th>
                            <th class="text-right">P99 (ms)</th>
                            <th class="text-right">P99% (Δ)</th>
                            <th class="text-right">Error %</th>
                            <th x-show="hasSloTargets()">SLO</th>
                            <th>Stable</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="step in stepHistory()" :key="step.step ?? step.concurrency">
                            <tr :style="step.stable === false && !step.is_backoff ? 'background: #fef2f2;' : (step.is_backoff ? 'background: #fffbeb;' : (step.active_nodes != null && step.active_nodes < step.total_nodes ? 'background: #fef3c7;' : ''))">
                                <td class="text-right" x-text="step.step ?? '-'"></td>
                                <td class="text-right" x-text="formatInt(step.concurrency)"></td>
                                <td class="text-right" x-show="stepHistorySummary()?.is_aggregate" x-text="formatInt(step.total_concurrency)"></td>
                                <td class="text-right" x-show="stepHistorySummary()?.is_aggregate">
                                    <span :style="step.active_nodes < step.total_nodes ? 'color: #d97706;' : ''" x-text="step.active_nodes + '/' + step.total_nodes"></span>
                                </td>
                                <td class="text-right" x-text="formatMs(step.qps)"></td>
                                <td class="text-right" x-text="formatMs(step.p95_latency_ms)"></td>
                                <td class="text-right" x-text="formatSignedPct(stepP95DiffPct(step))"></td>
                                <td class="text-right" x-text="formatMs(step.p99_latency_ms)"></td>
                                <td class="text-right" x-text="formatSignedPct(stepP99DiffPct(step))"></td>
                                <td class="text-right" x-text="formatMs(step.error_rate_pct) + '%'"></td>
                                <td x-show="hasSloTargets()">
                                    <span class="status-badge" :class="stepSloBadgeClass(step)" x-text="stepSloStatus(step)"></span>
                                </td>
                                <td>
                                    <span 
                                        :style="step.stable ? 'color: #059669;' : (step.degraded === true ? 'color: #dc2626;' : 'color: #dc2626;')"
                                        x-text="step.is_backoff ? 'Backoff' : (step.degraded === true ? 'Degraded' : (step.stable ? 'Yes' : (step.stable === false ? 'No' : '-')))"
                                    ></span>
                                </td>
                                <td style="color: #6b7280; font-size: 0.875rem;" x-text="(step.degrade_reasons && step.degrade_reasons.length ? step.degrade_reasons.join(', ') : null) || step.stop_reason || '-'"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts section wrapper for floating toolbar visibility detection -->
    <div data-section="charts">

    <div class="card">
        <div class="card-title">Real-Time Metrics (captured)</div>
        <div class="chart-container">
            <canvas id="throughputChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Latency Distribution (end-to-end)</div>
        <div class="chart-container">
            <canvas id="latencyChart"></canvas>
        </div>
        <div style="margin-top: 0.5rem; color: #6b7280;">
            Note: charts are based on end-to-end app timings collected during execution.
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <div class="card-title" style="margin-bottom: 0;">Operations Per Second (app)</div>
            <div style="display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <div style="font-weight: 600;">Breakdown:</div>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="opsSecBreakdown === 'read_write' ? 'btn-primary' : 'btn-secondary'"
                    @click="setOpsSecBreakdown('read_write')"
                    :disabled="!_opsSecHasBreakdown"
                    :title="!_opsSecHasBreakdown ? 'No breakdown data available for this run' : ''"
                >
                    Read / Write
                </button>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="opsSecBreakdown === 'by_kind' ? 'btn-primary' : 'btn-secondary'"
                    @click="setOpsSecBreakdown('by_kind')"
                    :disabled="!_opsSecHasBreakdown"
                    :title="!_opsSecHasBreakdown ? 'No breakdown data available for this run' : ''"
                >
                    Point / Range / Insert / Update
                </button>
            </div>
        </div>
        <div style="color: #6b7280; margin-top: 0.5rem;">
            App-side operations per second breakdown, captured from internal counters during execution.
        </div>
        <div 
            x-show="_opsSecHasBreakdown === false" 
            style="color: #b45309; background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; font-size: 0.875rem;"
        >
            <strong>Note:</strong> Breakdown by query type is unavailable for this run. Only the aggregate "Total" series is shown.
        </div>
        <div class="chart-container" style="margin-top: 0.75rem;">
            <canvas id="opsSecChart"></canvas>
        </div>
    </div>

    <div class="card" x-show="!['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())">
        <div style="display:flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <div class="card-title" style="margin-bottom: 0;">Snowflake Running Queries (Server)</div>
            <div style="display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <div style="font-weight: 600;">Breakdown:</div>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="sfRunningBreakdown === 'read_write' ? 'btn-primary' : 'btn-secondary'"
                    @click="setSfRunningBreakdown('read_write')"
                    :disabled="!_sfRunningHasBreakdown"
                    :title="!_sfRunningHasBreakdown ? 'No breakdown data available for this run' : ''"
                >
                    Read / Write
                </button>
                <button
                    type="button"
                    class="btn btn-sm"
                    :class="sfRunningBreakdown === 'by_kind' ? 'btn-primary' : 'btn-secondary'"
                    @click="setSfRunningBreakdown('by_kind')"
                    :disabled="!_sfRunningHasBreakdown"
                    :title="!_sfRunningHasBreakdown ? 'No breakdown data available for this run' : ''"
                >
                    Point / Range / Insert / Update
                </button>
            </div>
        </div>
        <div style="color: #6b7280; margin-top: 0.5rem;">
            Captured during the run from <code>INFORMATION_SCHEMA.QUERY_HISTORY_BY_WAREHOUSE</code> (per-test <code>QUERY_TAG</code>) and stored in per-second snapshots.
            "Total" is the sum of benchmark statements (best-effort). If kind tagging is unavailable for a run, the chart falls back to Snowflake's per-test Running total.
        </div>
        <div 
            x-show="_sfRunningHasBreakdown === false" 
            style="color: #b45309; background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; font-size: 0.875rem;"
        >
            <strong>Note:</strong> Breakdown by query type is unavailable for this run. Only the aggregate "Total" series is shown.
        </div>
        <div class="chart-container" style="margin-top: 0.75rem;">
            <canvas id="sfRunningChart"></canvas>
        </div>
    </div>

    <div
        class="card"
        x-show="!['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())"
    >
        <div class="card-title">App Overhead (per-second)</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Network/client overhead derived from enriched queries: <code>APP_ELAPSED_MS - SF_TOTAL_ELAPSED_MS</code>.
            Dashed lines show average latencies; the shaded area shows P50 overhead.
        </div>

        <div x-show="overheadTsError" class="alert alert-error" style="margin-top: 1rem;">
            <strong>Failed to load overhead data.</strong>
            <span x-text="overheadTsError"></span>
        </div>

        <div x-show="!overheadTsError && overheadTsLoading" style="margin-top: 1rem;">
            {% include "components/loading_spinner.html" %}
        </div>

        <div
            x-show="overheadTsLoaded && !overheadTsError && !overheadTsLoading && !overheadTsAvailable"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            No per-second overhead data available (requires enrichment from QUERY_HISTORY).
        </div>

        <div
            x-show="overheadTsAvailable"
            class="chart-container"
            style="margin-top: 1rem;"
        >
            <canvas id="overheadChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">Worker Concurrency (captured)</div>
        <div class="chart-container">
            <canvas id="concurrencyChart"></canvas>
        </div>
    </div>

    <div
        class="card"
        x-show="templateInfo && isFinalMetricsReady() && !['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())"
    >
        <div class="card-title">Warehouse Queueing + MCW (post-processed)</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Derived from <code>INFORMATION_SCHEMA.QUERY_HISTORY</code> after the run completes.
        </div>

        <div x-show="templateInfo && templateInfo.warehouse_metrics_available" style="margin-top: 1rem;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">
                        <span>Clusters Used</span>
                        <span
                            class="info-icon"
                            title="Clusters used: number of active clusters observed for the warehouse during the run (post-processed from QUERY_HISTORY)."
                        >i</span>
                    </div>
                    <div class="metric-value" x-text="formatInt(templateInfo?.warehouse_metrics?.clusters_used)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        <span>Queued (Overload)</span>
                        <span
                            class="info-icon"
                            title="Queued time (overload): total time queries spent queued due to warehouse overload (post-processed from QUERY_HISTORY)."
                        >i</span>
                    </div>
                    <div class="metric-value" x-text="formatMsWithUnit(templateInfo?.warehouse_metrics?.total_queued_overload_ms)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        <span>Queued (Provisioning)</span>
                        <span
                            class="info-icon"
                            title="Queued time (provisioning): total time queries spent queued while the warehouse was provisioning/resuming (post-processed from QUERY_HISTORY)."
                        >i</span>
                    </div>
                    <div class="metric-value" x-text="formatMsWithUnit(templateInfo?.warehouse_metrics?.total_queued_provisioning_ms)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        <span>Queries w/ Overload Queue</span>
                        <span
                            class="info-icon"
                            title="Count of queries that experienced overload queueing during the run (post-processed from QUERY_HISTORY)."
                        >i</span>
                    </div>
                    <div class="metric-value" x-text="formatInt(templateInfo?.warehouse_metrics?.queries_with_overload_queue)"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">
                        <span>Read Cache Hit</span>
                        <span
                            class="info-icon"
                            title="Read cache hit: percent of reads served from the warehouse local cache during this run (post-processed)."
                        >i</span>
                    </div>
                    <div class="metric-value" x-text="formatPct(templateInfo?.warehouse_metrics?.read_cache_hit_pct)"></div>
                </div>
            </div>
        </div>

        <div
            x-show="templateInfo && !templateInfo.warehouse_metrics_available"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            Warehouse/cluster metrics are unavailable for this run (usually because query-history collection was disabled).
        </div>

        <div x-show="templateInfo && templateInfo.cluster_breakdown_available" style="margin-top: 1rem;">
            <div 
                style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;"
                @click="toggleClusterBreakdown()"
            >
                <span 
                    style="display: inline-block; width: 1rem; text-align: center; transition: transform 0.15s;"
                    :style="clusterBreakdownExpanded ? 'transform: rotate(90deg);' : ''"
                >▶</span>
                <span style="font-weight: 600;">Per-cluster breakdown</span>
                <span style="color: #6b7280; font-size: 0.875rem;" x-text="clusterBreakdownExpanded ? '(click to collapse)' : '(click to expand)'"></span>
            </div>
            <div class="table" style="margin-top: 0.5rem;">
                <table>
                    <thead>
                        <tr>
                            <th class="text-right">Cluster</th>
                            <th class="text-right">Query Count</th>
                            <th class="text-right">P50 Exec (ms)</th>
                            <th class="text-right">P95 Exec (ms)</th>
                            <th class="text-right">Avg Queue Overload (ms)</th>
                            <th class="text-right">Avg Queue Provisioning (ms)</th>
                            <th>Mix (counts)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr x-show="clusterBreakdownSummary()" style="background: #f8fafc; font-weight: 500;">
                            <td class="text-right" x-text="clusterBreakdownSummary()?.cluster_count + ' clusters'"></td>
                            <td class="text-right" x-text="formatInt(clusterBreakdownSummary()?.total_queries)"></td>
                            <td class="text-right" x-text="formatMs(clusterBreakdownSummary()?.avg_p50_exec_ms)"></td>
                            <td class="text-right" x-text="formatMs(clusterBreakdownSummary()?.avg_p95_exec_ms)"></td>
                            <td class="text-right" x-text="formatMs(clusterBreakdownSummary()?.avg_queued_overload_ms)"></td>
                            <td class="text-right" x-text="formatMs(clusterBreakdownSummary()?.avg_queued_provisioning_ms)"></td>
                            <td style="color: #6b7280;">
                                <span x-text="`PL ${formatInt(clusterBreakdownSummary()?.total_point_lookups)} • RS ${formatInt(clusterBreakdownSummary()?.total_range_scans)} • INS ${formatInt(clusterBreakdownSummary()?.total_inserts)} • UPD ${formatInt(clusterBreakdownSummary()?.total_updates)}${clusterBreakdownSummary()?.unattributed_queries ? ` • UNK ${formatInt(clusterBreakdownSummary()?.unattributed_queries)}` : ''}`"></span>
                            </td>
                        </tr>
                        <template x-for="c in (templateInfo?.cluster_breakdown || [])" :key="c.cluster_number">
                            <tr x-show="clusterBreakdownExpanded">
                                <td class="text-right" x-text="clusterLabel(c)"></td>
                                <td class="text-right" x-text="formatInt(c.query_count)"></td>
                                <td class="text-right" x-text="formatMs(c.p50_exec_ms)"></td>
                                <td class="text-right" x-text="formatMs(c.p95_exec_ms)"></td>
                                <td class="text-right" x-text="formatMs(c.avg_queued_overload_ms)"></td>
                                <td class="text-right" x-text="formatMs(c.avg_queued_provisioning_ms)"></td>
                                <td style="color: #6b7280;">
                                    <span x-text="`PL ${formatInt(c.point_lookups)} • RS ${formatInt(c.range_scans)} • INS ${formatInt(c.inserts)} • UPD ${formatInt(c.updates)}`"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">
                Unattributed = queries missing cluster number from query history enrichment.
            </div>
        </div>
    </div>

    <div class="card" x-show="templateInfo && isFinalMetricsReady() && !['postgres', 'snowflake_postgres'].includes((templateInfo?.table_type || '').toLowerCase())">
        <div class="card-title">MCW Nodes + Queue (per-second)</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Aligned to per-second metrics snapshots. "Active clusters" comes from <code>V_WAREHOUSE_TIMESERIES.ACTIVE_CLUSTERS</code>.
        </div>

        <div
            x-show="warehouseTsAvailable"
            style="margin-top: 0.75rem; display:flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;"
        >
            <div style="font-weight: 600;">Queue view:</div>
            <button
                type="button"
                class="btn btn-sm"
                :class="warehouseQueueMode === 'avg' ? 'btn-primary' : 'btn-secondary'"
                @click="setWarehouseQueueMode('avg')"
            >
                Avg queued ms (per query / second)
            </button>
            <button
                type="button"
                class="btn btn-sm"
                :class="warehouseQueueMode === 'total' ? 'btn-primary' : 'btn-secondary'"
                @click="setWarehouseQueueMode('total')"
            >
                Total queued ms (sum / second)
            </button>
        </div>

        <div x-show="warehouseTsError" class="alert alert-error" style="margin-top: 1rem;">
            <strong>Failed to load warehouse time series.</strong>
            <span x-text="warehouseTsError"></span>
        </div>

        <div x-show="!warehouseTsError && warehouseTsLoading" style="margin-top: 1rem;">
            {% include "components/loading_spinner.html" %}
        </div>

        <div
            x-show="warehouseTsLoaded && !warehouseTsError && !warehouseTsLoading && !warehouseTsAvailable"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            No per-second warehouse data available for this run (requires query-history collection + post-processing).
        </div>

        <div
            x-show="warehouseTsAvailable"
            class="chart-container"
            style="margin-top: 1rem;"
        >
            <canvas id="warehouseQueueChart"></canvas>
        </div>
    </div>

    </div><!-- end data-section="charts" wrapper -->

    <div class="card" x-show="metrics.resources_available">
        <div
            style="display:flex; align-items: center; justify-content: space-between; gap: 0.75rem; cursor: pointer;"
            @click="toggleResourcesHistory()"
        >
            <div class="card-title" style="margin-bottom: 0;">Resources (captured)
                <span style="font-size: 0.75rem; font-weight: normal; color: #6b7280;">(averaged across all workers)</span>
            </div>
            <span
                style="display: inline-block; width: 1rem; text-align: center; transition: transform 0.15s;"
                :style="resourcesHistoryExpanded ? 'transform: rotate(90deg);' : ''"
            >▶</span>
        </div>
        <div class="metrics-grid" style="margin-top: 0.75rem;">
            <div class="metric-card">
                <div class="metric-label">
                    <span>CPU (host)</span>
                    <span class="info-icon" title="Host CPU usage captured during the run (cgroup-aware when limits are present).">i</span>
                </div>
                <div class="metric-value" x-text="formatPctValue(metrics.host_cpu_percent != null ? metrics.host_cpu_percent : metrics.cpu_percent)"></div>
                <div class="metric-change" style="display: flex; flex-direction: column; gap: 2px;">
                    <template x-if="metrics.cgroup_cpu_percent != null && metrics.cgroup_cpu_quota_cores != null">
                        <span x-text="'Cgroup: ' + formatPctValue(metrics.cgroup_cpu_percent) + ' of ' + formatCompact(metrics.cgroup_cpu_quota_cores) + ' cores'"></span>
                    </template>
                    <span x-text="'Process: ' + formatPctValue(metrics.cpu_percent)"></span>
                </div>
                <div style="height: 60px; margin-top: 0.5rem;">
                    <canvas id="resourcesCpuSparkline"></canvas>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">
                    <span>Memory (host)</span>
                    <span class="info-icon" title="Host memory usage captured during the run (cgroup-aware when limits are present).">i</span>
                </div>
                <div
                    class="metric-value"
                    x-text="metrics.host_memory_total_mb != null ? (formatCompact(metrics.host_memory_mb || 0) + ' / ' + formatCompact(metrics.host_memory_total_mb) + ' MB') : (formatCompact(metrics.memory_mb) + ' MB')"
                ></div>
                <div class="metric-change" style="display: flex; flex-direction: column; gap: 2px;">
                    <template x-if="metrics.host_memory_percent != null">
                        <span x-text="'Host: ' + formatPctValue(metrics.host_memory_percent)"></span>
                    </template>
                    <template x-if="metrics.cgroup_memory_mb != null && metrics.cgroup_memory_limit_mb != null">
                        <span x-text="'Cgroup: ' + formatCompact(metrics.cgroup_memory_mb) + ' / ' + formatCompact(metrics.cgroup_memory_limit_mb) + ' MB (' + formatPctValue(metrics.cgroup_memory_percent) + ')'"></span>
                    </template>
                    <span x-text="'Process: ' + formatCompact(metrics.memory_mb) + ' MB'"></span>
                </div>
                <div style="height: 60px; margin-top: 0.5rem;">
                    <canvas id="resourcesMemSparkline"></canvas>
                </div>
            </div>
        </div>
        <div x-show="resourcesHistoryExpanded" x-cloak style="margin-top: 1rem;">
            <div class="chart-container">
                <canvas id="resourcesHistoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card" x-show="mode === 'history'">
        <div class="card-title">Worker Metrics (multi-worker)</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Aggregated per-worker snapshots from <code>WORKER_METRICS_SNAPSHOTS</code>.
        </div>

        <div x-show="workerMetricsError" class="alert alert-error" style="margin-top: 1rem;">
            <strong>Failed to load worker metrics.</strong>
            <span x-text="workerMetricsError"></span>
        </div>

        <div x-show="!workerMetricsError && workerMetricsLoading" style="margin-top: 1rem;">
            {% include "components/loading_spinner.html" %}
        </div>

        <div
            x-show="!workerMetricsError && !workerMetricsLoading && !workerMetricsAvailable"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            No per-worker metrics available for this run.
        </div>

        <div
            x-show="!workerMetricsError && !workerMetricsLoading && workerMetricsAvailable"
            style="margin-top: 1rem;"
        >
            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Worker</th>
                            <th>Group</th>
                            <th>QPS</th>
                            <th>P95</th>
                            <th>CPU %</th>
                            <th>Memory (MB)</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="worker in workerMetricsWorkers" :key="worker.key">
                            <tr>
                                <td x-text="worker.worker_id || ('group-' + worker.worker_group_id)"></td>
                                <td x-text="worker.worker_group_id"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.qps : 0)"></td>
                                <td x-text="formatMsWithUnit(worker.latest ? worker.latest.p95_latency : 0)"></td>
                                <td x-text="formatPctValue(worker.latest ? worker.latest.resources_host_cpu_percent : 0)"></td>
                                <td x-text="formatCompact(worker.latest ? worker.latest.resources_host_memory_mb : 0)"></td>
                                <td>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-secondary"
                                        @click="toggleWorkerMetrics(worker)"
                                    >
                                        <span x-text="workerMetricsExpanded[worker.key] ? 'Hide' : 'Show'"></span>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <template x-for="worker in workerMetricsWorkers" :key="'expanded-' + worker.key">
                            <tr x-show="workerMetricsExpanded[worker.key]" x-cloak>
                                <td colspan="7">
                                    <div class="chart-container" style="height: 220px;">
                                        <canvas :id="'workerMetricsChart-' + worker.key"></canvas>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" x-show="mode === 'history'">
        <div class="card-title">Error Summary</div>
        <div style="color: #6b7280; margin-top: -0.25rem;">
            Aggregated from <code>INFORMATION_SCHEMA.QUERY_HISTORY</code> (Snowflake, filtered by <code>QUERY_TAG</code>)
            plus app-captured local failures (connector/runtime, <code>LOCAL_*</code>).
        </div>

        <div x-show="errorSummaryError" class="alert alert-error" style="margin-top: 1rem;">
            <strong>Failed to load error summary.</strong>
            <span x-text="errorSummaryError"></span>
        </div>

        <div x-show="!errorSummaryError && errorSummaryLoading" style="margin-top: 1rem;">
            {% include "components/loading_spinner.html" %}
        </div>

        <div
            x-show="errorSummaryLoaded && !errorSummaryError && !errorSummaryLoading && (!errorSummaryRows || errorSummaryRows.length === 0)"
            class="alert alert-info"
            style="margin-top: 1rem;"
        >
            No errors found for this test.
        </div>

        <div x-show="errorSummaryLoaded && !errorSummaryError && !errorSummaryLoading && errorSummaryRows && errorSummaryRows.length" style="margin-top: 1rem;">
            <div class="table">
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Error Summary</th>
                            <th>Error Message</th>
                            <th class="text-right">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="row in errorSummaryRows" :key="(row.source || '') + '|' + (row.summary || '') + '|' + (row.message || '')">
                            <tr>
                                <td x-text="row.source"></td>
                                <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" x-text="row.summary"></td>
                                <td style="color: #374151;" x-text="row.message"></td>
                                <td class="text-right" x-text="formatInt(row.count)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" x-show="mode === 'history'">
        <div class="card-title">Run Logs</div>

        <div class="log-controls">
            <div class="log-control" x-show="logTargets && logTargets.length">
                <label class="form-label">Source</label>
                <select class="form-select" x-model="logSelectedTargetId" @change="onLogTargetChange()">
                    <template x-for="target in logTargets" :key="target.target_id || target.test_id">
                        <option
                            :value="target.target_id || target.test_id"
                            x-text="target.label || target.worker_id || target.test_id"
                        ></option>
                    </template>
                </select>
            </div>
            <div class="log-control">
                <label class="form-label">Level</label>
                <select class="form-select" x-model="logLevelFilter">
                    <template x-for="opt in logLevelOptions()" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label"></option>
                    </template>
                </select>
            </div>
            <div class="log-control log-control-toggle">
                <label class="form-label">
                    <input type="checkbox" class="form-checkbox" x-model="logVerboseMode">
                    Verbose mode
                </label>
            </div>
        </div>

        <div
            class="alert alert-error"
            x-show="(status || '').toUpperCase() === 'FAILED'"
        >
            Test failed. See logs below.
        </div>

        <div class="log-output">
            <template x-if="filteredLogs().length === 0">
                <div class="log-empty">No logs yet.</div>
            </template>
            <template x-for="log in filteredLogs()" :key="log.log_id">
                <div class="log-line">
                    <span class="log-ts" x-text="formatLogTimestamp(log.timestamp)"></span>
                    <span class="log-level" :class="logLineLevelClass(log.level)" x-text="(log.level || 'INFO').toUpperCase()"></span>
                    <button
                        type="button"
                        :class="logWorkerBadgeClass(log.worker_id)"
                        @click="setLogWorkerFilter(_normalizeWorkerId(log.worker_id))"
                        x-text="_normalizeWorkerId(log.worker_id)"
                    ></button>
                    <span class="log-logger" x-text="formatLogLogger(log.logger)"></span>
                    <span class="log-sep">-</span>
                    <span class="log-message" x-text="log.message"></span>
                    <template x-if="log.exception">
                        <pre class="log-exception" x-text="log.exception"></pre>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}

