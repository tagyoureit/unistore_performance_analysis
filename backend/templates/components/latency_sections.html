{# Shared latency UI: toggle + KPI cards + detailed tables.
   Expects Alpine state from dashboard.js:
   - latencyView: 'end_to_end' | 'sf_execution'
   - setLatencyView(view)
   - sfLatencyAvailable()
   - sfLatencyDisabledReason()
   - formatMs(value)
   - currentLatencyMs(pct)   # pct: 95 or 99
   - detailLatency(fieldName) # e.g. 'read_p95_latency_ms'
   - latencyViewLabel()
   - templateInfo, metrics
#}

<!-- Latency section wrapper for floating toolbar visibility detection -->
<div data-section="latency">

<!-- Tailwind safelist: ensure dynamic classes are included in CSS build -->
<span class="hidden bg-green-100 text-green-800 bg-red-100 text-red-800"></span>

<div
    x-show="mode === 'history' && latencyView === 'sf_execution' && sfEnrichmentLowWarning()"
    class="enrichment-warning bg-amber-100 border border-amber-500 rounded-md py-3 px-4 mb-4 flex items-start gap-2"
>
    <span class="text-amber-700 text-lg">⚠</span>
    <div class="text-sm text-amber-900">
        <strong>Low enrichment:</strong>
        Only <span x-text="sfEnrichmentSampleCount()?.toLocaleString() || 0"></span> of <span x-text="sfEnrichmentTotalQueries()?.toLocaleString() || 0"></span>
        queries (<span x-text="sfEnrichmentRatioPct() || 0"></span>%) were matched in Snowflake QUERY_HISTORY.
        <template x-if="sfEstimatedAvailable() && (templateInfo?.sf_estimated_p50_latency_ms || 0) > 0">
            <span>Values shown are <strong>estimated</strong> by subtracting median network overhead (<span x-text="templateInfo?.sf_enrichment_p50_overhead_ms?.toFixed(0) || '?'"></span>ms) from end-to-end times.</span>
        </template>
        <template x-if="!sfEstimatedAvailable() || (templateInfo?.sf_estimated_p50_latency_ms || 0) <= 0">
            <span>Values shown are from a <strong>biased sample</strong> (Snowflake logs slower queries preferentially at high QPS). The actual SF execution times are likely lower.</span>
        </template>
    </div>
</div>

<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">
            <span>QPS</span>
            <span
                class="info-icon"
                title="Throughput (QPS): completed benchmark operations per second. Live view shows 30-second rolling average for stability; history view shows overall average."
            >i</span>
        </div>
        <div class="metric-value" x-text="mode === 'history' ? formatCompact(templateInfo?.qps || 0) : formatCompact(metrics.qps_avg_30s)"></div>
        <div class="metric-change flex flex-col gap-0.5">
            <template x-if="mode === 'live'">
                <span>Instant: <span x-text="formatCompact(metrics.ops_per_sec)"></span></span>
            </template>
            <template x-if="mode === 'history' && qpsTarget()">
                <span x-text="formatCompact(templateInfo?.qps || 0) + ' / ' + formatCompact(qpsTarget()) + ' target'"></span>
            </template>
            <template x-if="mode === 'live' && qpsTarget()">
                <span x-text="(qpsTargetPct() >= 100 ? '+' : '') + (qpsTargetPct() - 100).toFixed(0) + '% vs target (' + formatCompact(qpsTarget()) + ')'"></span>
            </template>
        </div>
    </div>

    <div class="metric-card" x-show="mode === 'live'">
        <div class="metric-label">
            <span>In-flight Queries</span>
            <span
                class="info-icon"
                title="Concurrency (client): number of benchmark DB operations currently in progress (connections checked out / awaiting results). Includes client/network/connector time, plus any time spent queued/blocked server-side."
            >i</span>
        </div>
        <div class="metric-value" x-text="formatCompact(metrics.in_flight)"></div>
        <div class="metric-change">Concurrent DB operations</div>
    </div>

    <!-- Hide Snowflake Running KPI for Postgres table types -->
    <div class="metric-card" x-show="mode === 'live' && (templateInfo?.table_type || '').toLowerCase() !== 'postgres'">
        <div class="metric-label">
            <span
                x-text="metrics.sf_bench_available ? 'Snowflake Running (bench)' : 'Snowflake Running'"
            ></span>
            <span
                class="info-icon"
                title="Concurrency (server): Snowflake-reported Running queries. When labeled "(bench)", it is filtered to this test via QUERY_TAG and is the most accurate 'real concurrent queries' signal."
            >i</span>
        </div>
        <div
            class="metric-value"
            x-text="formatCompact(metrics.sf_bench_available ? metrics.sf_running_bench : metrics.sf_running)"
        ></div>
        <div
            class="metric-change"
            x-text="
              formatCompact(metrics.sf_bench_available ? metrics.sf_queued_bench : metrics.sf_queued) +
              ' queued' +
              (metrics.sf_bench_available && (metrics.sf_blocked_bench || 0) > 0
                ? ' • ' + formatCompact(metrics.sf_blocked_bench) + ' blocked'
                : '')
            "
        ></div>
    </div>
</div>

<div
    x-show="mode === 'history' && latencySpreadWarning()"
    class="latency-spread-warning bg-amber-100 border border-amber-500 rounded-md py-3 px-4 mb-4 flex items-start gap-2"
>
    <span class="text-amber-700 text-lg">⚠</span>
    <div class="text-sm text-amber-900">
        <strong>High latency variance:</strong>
        P95 is <span x-text="latencySpreadRatio()?.toFixed(1) || '?'"></span>x the median (P50).
        <template x-if="latencyView === 'sf_execution'">
            <span>Snowflake execution times are highly variable. Common causes: warehouse contention, multi-cluster scaling, cold cache hits, or query compilation overhead.</span>
        </template>
        <template x-if="latencyView !== 'sf_execution'">
            <span>End-to-end response times are highly variable. Common causes: network latency spikes, client-side processing, or Snowflake queueing under load.</span>
        </template>
    </div>
</div>

<div class="metrics-grid">
    <div class="metric-card info">
        <div class="metric-label">
            <span x-text="'P50 (Median)'"></span>
            <span
                class="info-icon"
                :title="latencyCardTitle(50)"
            >i</span>
        </div>
        <div class="metric-value-with-detail">
            <span class="metric-value-main" x-text="formatMsWithUnit(currentLatencyMs(50))"></span>
            <span class="metric-value-precise" x-text="formatMsPrecise(currentLatencyMs(50))"></span>
        </div>
        <div class="metric-change" x-text="latencyViewLabel()"></div>
    </div>

    <div class="metric-card success">
        <div class="metric-label">
            <span x-text="'P95 Latency'"></span>
            <span
                class="info-icon"
                :title="latencyCardTitle(95)"
            >i</span>
        </div>
        <div class="metric-value-with-detail">
            <span class="metric-value-main" x-text="formatMsWithUnit(currentLatencyMs(95))"></span>
            <span class="metric-value-precise" x-text="formatMsPrecise(currentLatencyMs(95))"></span>
        </div>
        <div class="metric-change flex items-center gap-2">
            <span x-text="latencyViewLabel()"></span>
            <span
                x-show="mode === 'history' && latencySpreadRatio() != null"
                class="text-xs px-1.5 py-0.5 rounded font-medium"
                :class="latencySpreadClass()"
                :title="'Spread ratio: P95 is ' + (latencySpreadRatio()?.toFixed(1) || '?') + 'x P50. Low (<3x) = consistent, High (>5x) = variable tail latency.'"
                x-text="latencySpreadRatio()?.toFixed(1) + 'x spread'"
            ></span>
        </div>
    </div>

    <div class="metric-card warning">
        <div class="metric-label">
            <span x-text="'P99 Latency'"></span>
            <span
                class="info-icon"
                :title="latencyCardTitle(99)"
            >i</span>
        </div>
        <div class="metric-value-with-detail">
            <span class="metric-value-main" x-text="formatMsWithUnit(currentLatencyMs(99))"></span>
            <span class="metric-value-precise" x-text="formatMsPrecise(currentLatencyMs(99))"></span>
        </div>
        <div class="metric-change" x-text="latencyViewLabel()"></div>
    </div>

    <div class="metric-card error">
        <div class="metric-label">
            <span>Error Rate</span>
            <span
                class="info-icon"
                title="Error rate: percent of operations that failed (errors / total)."
            >i</span>
        </div>
        <div class="metric-value" x-text="(metrics.error_rate || 0).toFixed(2) + '%'"></div>
        <div class="metric-change" x-text="metrics.total_errors + ' errors'"></div>
    </div>
</div>

<div class="card" x-show="mode === 'live' && isFindMaxMode()">
    <div class="card-title">Find Max (step-load) (live)</div>
    <div class="text-sm text-gray-700 -mt-1">
        Step-load controller metrics (baseline vs current latency, upcoming worker change, and conclusion reason).
    </div>

    <div class="overflow-x-auto mt-3">
        <table class="w-full border-collapse">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2 text-left border-b-2 border-gray-200 whitespace-nowrap">Step</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">Established P95 (baseline)</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">Current P95</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">% diff</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">P95 drift threshold</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">Current P99</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">P99 drift threshold</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">Error %</th>
                    <th class="p-2 text-right border-b-2 border-gray-200 whitespace-nowrap">Max Error %</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="p-2 border-b border-gray-200 font-medium" x-text="'Step ' + (findMaxState()?.current_step ?? '—')"></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatMsWithUnit(findMaxBaselineP95Ms())"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(findMaxCurrentP95Ms(), findMaxP95MaxThresholdMs())"
                        x-text="formatMsWithUnit(findMaxCurrentP95Ms())"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200"
                        x-text="
                            (findMaxP95DiffPct() == null)
                                ? 'N/A'
                                : ((findMaxP95DiffPct() >= 0 ? '+' : '') + findMaxP95DiffPct().toFixed(1) + '%')
                        "
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatMsWithUnit(findMaxP95MaxThresholdMs())"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(findMaxCurrentP99Ms(), findMaxP99MaxThresholdMs())"
                        x-text="formatMsWithUnit(findMaxCurrentP99Ms())"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatMsWithUnit(findMaxP99MaxThresholdMs())"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(findMaxCurrentErrorPct(), findMaxMaxErrorPct(), true)"
                        x-text="formatPctValue(findMaxCurrentErrorPct())"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetPct(findMaxMaxErrorPct())"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="metrics-grid mt-4">
        <div class="metric-card">
            <div class="metric-label">
                <span>Threads</span>
                <span class="info-icon" title="Current step concurrency target → next planned concurrency. Countdown is until the controller re-evaluates and applies the next change (end of step).">i</span>
            </div>
            <div class="metric-value"
                x-text="
                    findMaxCurrentWorkers() == null
                        ? 'N/A'
                        : (findMaxNextWorkers() == null
                            ? findMaxCurrentWorkers()
                            : (findMaxCurrentWorkers() === findMaxNextWorkers() || findMaxAtMax()
                                ? findMaxCurrentWorkers() + ' (max)'
                                : findMaxCurrentWorkers() + ' → ' + findMaxNextWorkers()))
                "
            ></div>
        <div class="metric-change flex flex-col gap-0.5">
                <div x-show="findMaxActiveWorkers() != null" x-text="'Active Workers: ' + formatInt(findMaxActiveWorkers())"></div>
                <div x-show="findMaxNextWorkers() != null && !findMaxIsTransitioning()" x-text="'Next change in: ' + (findMaxCountdownSeconds != null ? (findMaxCountdownSeconds + 's') : '—')"></div>
                <div x-show="findMaxIsTransitioning()" class="text-yellow-600">Transitioning...</div>
            </div>
        </div>

        <div class="metric-card" x-show="findMaxState() && findMaxState().best_concurrency != null">
            <div class="metric-label">
                <span>Best So Far</span>
                <span class="info-icon" title="Best observed stable step so far (highest QPS).">i</span>
            </div>
            <div class="metric-value" x-text="formatInt(findMaxState()?.best_concurrency)"></div>
            <div class="metric-change" x-text="formatCompact(findMaxState()?.best_qps || 0) + ' QPS'"></div>
        </div>

        <div class="metric-card" x-show="findMaxConclusionReason()">
            <div class="metric-label">
                <span>Conclusion Reason</span>
                <span class="info-icon" title="Plain-text reason for why the FIND_MAX_CONCURRENCY run stopped or completed.">i</span>
            </div>
            <div class="metric-value text-base leading-normal whitespace-pre-wrap" x-text="findMaxConclusionReason()"></div>
            <div class="metric-change" x-text="'Status: ' + (status || '')"></div>
        </div>
    </div>
</div>

<!-- QPS Controller Card (for FIXED/BOUNDED modes with target QPS) - LIVE MODE -->
<div class="card" x-show="mode === 'live' && isQPSMode()">
    <div class="card-title">QPS Controller</div>

    <!-- Main Status Row -->
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
        <span style="font-size: 1.5rem;" x-text="qpsControllerStatus().icon"></span>
        <div>
            <div style="font-size: 1.125rem; font-weight: 600;" :class="qpsControllerStatus().class" x-text="qpsControllerStatus().label"></div>
            <div style="font-size: 0.75rem; color: #6b7280;">
                <span 
                    :class="{
                        'text-green-700': Math.abs(qpsVsTargetPct() || 0) < 5,
                        'text-amber-600': Math.abs(qpsVsTargetPct() || 0) >= 5 && Math.abs(qpsVsTargetPct() || 0) < 15,
                        'text-red-700': Math.abs(qpsVsTargetPct() || 0) >= 15
                    }"
                    x-text="qpsVsTargetPct() == null ? '—' : ((qpsVsTargetPct() >= 0 ? '+' : '') + qpsVsTargetPct().toFixed(1) + '% vs target')"></span>
                <span style="color: #9ca3af; font-size: 0.65rem;">(±5% OK)</span>
                <span style="color: #9ca3af; margin-left: 0.75rem;">• Evaluates every ~10s</span>
            </div>
        </div>
    </div>

    <!-- Last Adjustment -->
    <div class="mt-4 pt-3 border-t border-gray-200" x-show="qpsLastStepObject()">
        <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Last Adjustment</div>
        <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.875rem;">
            <span style="color: #6b7280;" x-text="qpsLastAdjustmentTimeAgo() || '—'"></span>
            <span style="font-weight: 500;"
                :class="{
                    'text-blue-600': qpsLastStepObject()?.direction === 'up',
                    'text-orange-600': qpsLastStepObject()?.direction === 'down'
                }">
                <span x-text="qpsLastStepObject()?.direction === 'up' ? '↑' : '↓'"></span>
                <span x-text="qpsLastStepObject()?.from_threads + ' → ' + qpsLastStepObject()?.to_threads + ' threads'"></span>
            </span>
            <span style="color: #6b7280;" x-text="formatControllerReason(qpsLastStepObject()?.reason)"></span>
        </div>
    </div>
    <div class="mt-4 pt-3 border-t border-gray-200" style="font-size: 0.875rem; color: #6b7280;" x-show="!qpsLastStepObject()">
        No adjustments yet — controller is monitoring QPS.
    </div>

    <!-- Collapsible Step History -->
    <div class="mt-3" x-show="qpsStepHistory() && qpsStepHistory().length > 1" x-data="{ showHistory: false }">
        <button
            @click="showHistory = !showHistory"
            class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1"
        >
            <span x-text="showHistory ? '▼' : '▶'"></span>
            <span x-text="'All adjustments (' + qpsStepHistory().length + ')'"></span>
        </button>
        <div x-show="showHistory" x-transition class="mt-2 overflow-x-auto">
            <table class="w-full border-collapse text-xs" style="table-layout: fixed;">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-1.5 text-left border-b border-gray-200" style="width: 2rem;">#</th>
                        <th class="p-1.5 text-left border-b border-gray-200" style="width: 4.5rem;">Time</th>
                        <th class="p-1.5 text-center border-b border-gray-200" style="width: 3.5rem;">Change</th>
                        <th class="p-1.5 text-right border-b border-gray-200" style="width: 5.5rem;">Threads</th>
                        <th class="p-1.5 text-right border-b border-gray-200" style="width: 5rem;">Gap</th>
                        <th class="p-1.5 text-left border-b border-gray-200" style="padding-left: 1rem;">Reason</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="step in (qpsStepHistory() || []).slice().reverse()" :key="step.step">
                        <tr>
                            <td class="p-1.5 border-b border-gray-100" x-text="step.step"></td>
                            <td class="p-1.5 border-b border-gray-100 text-gray-500" x-text="formatTimeAgo(step.timestamp)"></td>
                            <td class="p-1.5 text-center border-b border-gray-100"
                                :class="{
                                    'text-blue-600': step.direction === 'up',
                                    'text-orange-600': step.direction === 'down'
                                }"
                                x-text="step.direction === 'up' ? '↑ Up' : '↓ Down'"></td>
                            <td class="p-1.5 text-right border-b border-gray-100" x-text="step.from_threads + ' → ' + step.to_threads"></td>
                            <td class="p-1.5 text-right border-b border-gray-100" x-text="step.qps_error_pct != null ? ((step.qps_error_pct >= 0 ? '+' : '') + step.qps_error_pct.toFixed(1) + '%') : '—'"></td>
                            <td class="p-1.5 border-b border-gray-100 text-gray-600" style="padding-left: 1rem;" x-text="formatControllerReason(step.reason)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- QPS Controller Card - HISTORY MODE (shows step history only) -->
<div class="card" x-show="mode === 'history' && isQPSMode() && qpsStepHistory() && qpsStepHistory().length > 0" x-data="{ expanded: false }">
    <button @click="expanded = !expanded" class="w-full text-left flex items-center justify-between">
        <div class="card-title" style="margin-bottom: 0;">QPS Controller History</div>
        <span class="text-gray-400 text-sm" x-text="expanded ? '▼' : '▶'"></span>
    </button>

    <!-- Summary (always visible) -->
    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
        <span x-text="qpsStepHistory().length"></span> thread adjustments during test
        <span x-show="qpsTargetQps()">
            • Target: <span class="font-medium text-gray-900" x-text="formatInt(qpsTargetQps())"></span> QPS
        </span>
    </div>

    <!-- Step History Table (collapsible) -->
    <div x-show="expanded" x-transition class="mt-3 overflow-x-auto">
        <table class="w-full border-collapse text-xs" style="table-layout: fixed;">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-1.5 text-left border-b border-gray-200" style="width: 2rem;">#</th>
                    <th class="p-1.5 text-left border-b border-gray-200" style="width: 10rem;">Time</th>
                    <th class="p-1.5 text-center border-b border-gray-200" style="width: 3.5rem;">Change</th>
                    <th class="p-1.5 text-right border-b border-gray-200" style="width: 5.5rem;">Threads</th>
                    <th class="p-1.5 text-right border-b border-gray-200" style="width: 5rem;">Gap</th>
                    <th class="p-1.5 text-left border-b border-gray-200" style="padding-left: 1rem;">Reason</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="step in (qpsStepHistory() || []).slice().reverse()" :key="step.step">
                    <tr>
                        <td class="p-1.5 border-b border-gray-100" x-text="step.step"></td>
                        <td class="p-1.5 border-b border-gray-100 text-gray-500" x-text="formatTimestamp(step.timestamp)"></td>
                        <td class="p-1.5 text-center border-b border-gray-100"
                            :class="{
                                'text-blue-600': step.direction === 'up',
                                'text-orange-600': step.direction === 'down'
                            }"
                            x-text="step.direction === 'up' ? '↑ Up' : '↓ Down'"></td>
                        <td class="p-1.5 text-right border-b border-gray-100" x-text="step.from_threads + ' → ' + step.to_threads"></td>
                        <td class="p-1.5 text-right border-b border-gray-100" x-text="step.qps_error_pct != null ? ((step.qps_error_pct >= 0 ? '+' : '') + step.qps_error_pct.toFixed(1) + '%') : '—'"></td>
                        <td class="p-1.5 border-b border-gray-100 text-gray-600" style="padding-left: 1rem;" x-text="formatControllerReason(step.reason)"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
</div>

<div class="card mt-4" x-show="templateInfo">
    <div class="card-title">Targets (SLOs)</div>
    <div class="text-sm text-gray-700 -mt-1 flex items-center gap-2">
        <div><strong>Overall:</strong></div>
        <span class="status-badge" :class="sloOverallBadgeClass()" x-text="sloOverallStatus()"></span>
        <div class="text-gray-500">
            (strict: all query types with non-zero weight must meet enabled targets)
        </div>
    </div>

    <div x-show="sloOverallStatus() === 'DISABLED'" class="text-gray-500 mt-3">
        No SLO targets configured (all targets are disabled).
    </div>

    <div class="overflow-x-auto mt-3" x-show="sloOverallStatus() !== 'DISABLED'">
        <table class="w-full border-collapse">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2 text-left border-b-2 border-gray-200">Query Type</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">Weight</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">P95 (ms)</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">P95 Target</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">P99 (ms)</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">P99 Target</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">Error %</th>
                    <th class="p-2 text-right border-b-2 border-gray-200">Max Error %</th>
                    <th class="p-2 text-left border-b-2 border-gray-200">Status</th>
                </tr>
            </thead>
            <tbody>
                <tr x-show="workloadPct('POINT_LOOKUP') > 0">
                    <td class="p-2 border-b border-gray-200 font-medium">Point Lookup</td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="workloadPct('POINT_LOOKUP') + '%'"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP95Ms('POINT_LOOKUP'), sloTargetP95Ms('POINT_LOOKUP'))"
                        x-text="formatMs(sloObservedP95Ms('POINT_LOOKUP'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP95Ms('POINT_LOOKUP'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP99Ms('POINT_LOOKUP'), sloTargetP99Ms('POINT_LOOKUP'))"
                        x-text="formatMs(sloObservedP99Ms('POINT_LOOKUP'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP99Ms('POINT_LOOKUP'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedErrorPct('POINT_LOOKUP'), sloTargetErrorPct('POINT_LOOKUP'), true)"
                        x-text="formatPctValue(sloObservedErrorPct('POINT_LOOKUP'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetPct(sloTargetErrorPct('POINT_LOOKUP'))"></td>
                    <td class="p-2 border-b border-gray-200">
                        <span class="status-badge" :class="sloBadgeClass('POINT_LOOKUP')" x-text="sloRowStatus('POINT_LOOKUP')"></span>
                    </td>
                </tr>
                <tr x-show="workloadPct('RANGE_SCAN') > 0">
                    <td class="p-2 border-b border-gray-200 font-medium">Range Scan</td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="workloadPct('RANGE_SCAN') + '%'"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP95Ms('RANGE_SCAN'), sloTargetP95Ms('RANGE_SCAN'))"
                        x-text="formatMs(sloObservedP95Ms('RANGE_SCAN'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP95Ms('RANGE_SCAN'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP99Ms('RANGE_SCAN'), sloTargetP99Ms('RANGE_SCAN'))"
                        x-text="formatMs(sloObservedP99Ms('RANGE_SCAN'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP99Ms('RANGE_SCAN'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedErrorPct('RANGE_SCAN'), sloTargetErrorPct('RANGE_SCAN'), true)"
                        x-text="formatPctValue(sloObservedErrorPct('RANGE_SCAN'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetPct(sloTargetErrorPct('RANGE_SCAN'))"></td>
                    <td class="p-2 border-b border-gray-200">
                        <span class="status-badge" :class="sloBadgeClass('RANGE_SCAN')" x-text="sloRowStatus('RANGE_SCAN')"></span>
                    </td>
                </tr>
                <tr x-show="workloadPct('INSERT') > 0">
                    <td class="p-2 border-b border-gray-200 font-medium">Insert</td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="workloadPct('INSERT') + '%'"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP95Ms('INSERT'), sloTargetP95Ms('INSERT'))"
                        x-text="formatMs(sloObservedP95Ms('INSERT'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP95Ms('INSERT'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedP99Ms('INSERT'), sloTargetP99Ms('INSERT'))"
                        x-text="formatMs(sloObservedP99Ms('INSERT'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetMs(sloTargetP99Ms('INSERT'))"></td>
                    <td
                        class="p-2 text-right border-b border-gray-200"
                        :class="thresholdClass(sloObservedErrorPct('INSERT'), sloTargetErrorPct('INSERT'), true)"
                        x-text="formatPctValue(sloObservedErrorPct('INSERT'))"
                    ></td>
                    <td class="p-2 text-right border-b border-gray-200" x-text="formatTargetPct(sloTargetErrorPct('INSERT'))"></td>
                    <td class="p-2 border-b border-gray-200">
                        <span class="status-badge" :class="sloBadgeClass('INSERT')" x-text="sloRowStatus('INSERT')"></span>
                    </td>
                </tr>
                <tr x-show="workloadPct('UPDATE') > 0">
                    <td class="p-2 font-medium">Update</td>
                    <td class="p-2 text-right" x-text="workloadPct('UPDATE') + '%'"></td>
                    <td
                        class="p-2 text-right"
                        :class="thresholdClass(sloObservedP95Ms('UPDATE'), sloTargetP95Ms('UPDATE'))"
                        x-text="formatMs(sloObservedP95Ms('UPDATE'))"
                    ></td>
                    <td class="p-2 text-right" x-text="formatTargetMs(sloTargetP95Ms('UPDATE'))"></td>
                    <td
                        class="p-2 text-right"
                        :class="thresholdClass(sloObservedP99Ms('UPDATE'), sloTargetP99Ms('UPDATE'))"
                        x-text="formatMs(sloObservedP99Ms('UPDATE'))"
                    ></td>
                    <td class="p-2 text-right" x-text="formatTargetMs(sloTargetP99Ms('UPDATE'))"></td>
                    <td
                        class="p-2 text-right"
                        :class="thresholdClass(sloObservedErrorPct('UPDATE'), sloTargetErrorPct('UPDATE'), true)"
                        x-text="formatPctValue(sloObservedErrorPct('UPDATE'))"
                    ></td>
                    <td class="p-2 text-right" x-text="formatTargetPct(sloTargetErrorPct('UPDATE'))"></td>
                    <td class="p-2">
                        <span class="status-badge" :class="sloBadgeClass('UPDATE')" x-text="sloRowStatus('UPDATE')"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="text-gray-500 mt-3">
        SLO evaluation uses end-to-end (app) latency. The SQL-execution view is still available for diagnosing where time is spent.
    </div>
</div>

<div
    x-show="latencyView === 'sf_execution' && !sfLatencyAvailable()"
    class="card -mt-4"
>
    <div class="text-gray-500">
        SQL execution timings are available after processing completes (they come from
        <code>INFORMATION_SCHEMA.QUERY_HISTORY</code>).
    </div>
</div>

<div class="card" x-show="templateInfo && isFinalMetricsReady()">
    <div class="card-title">Detailed Latency Breakdown</div>
    <div class="text-gray-500 -mt-1">
        Values below reflect the selected latency view.
    </div>

    <div class="metrics-grid mt-4">
        <div class="metric-card" x-show="(templateInfo?.point_lookup_count || 0) + (templateInfo?.range_scan_count || 0) > 0">
            <div class="metric-label">
                <span>Read Operations</span>
                <span
                    class="info-icon"
                    title="Read operations: total completed reads (point lookups + range scans) during this run."
                >i</span>
            </div>
            <div class="metric-value" x-text="templateInfo?.read_operations || 0"></div>
            <div class="metric-change" x-text="(templateInfo?.reads_per_second || 0).toFixed(2) + ' ops/s'"></div>
        </div>
        <div class="metric-card" x-show="(templateInfo?.insert_count || 0) + (templateInfo?.update_count || 0) > 0">
            <div class="metric-label">
                <span>Write Operations</span>
                <span
                    class="info-icon"
                    title="Write operations: total completed writes (inserts + updates) during this run."
                >i</span>
            </div>
            <div class="metric-value" x-text="templateInfo?.write_operations || 0"></div>
            <div class="metric-change" x-text="(templateInfo?.writes_per_second || 0).toFixed(2) + ' ops/s'"></div>
        </div>
    </div>

    <h4 class="mt-6 mb-2 font-semibold" x-text="
        ((templateInfo?.point_lookup_count || 0) + (templateInfo?.range_scan_count || 0)) > 0 && 
        ((templateInfo?.insert_count || 0) + (templateInfo?.update_count || 0)) > 0 
            ? 'Read vs Write Latency' 
            : ((templateInfo?.point_lookup_count || 0) + (templateInfo?.range_scan_count || 0)) > 0 
                ? 'Read Latency' 
                : 'Write Latency'
    "></h4>
    <table class="w-full border-collapse mt-2">
        <thead class="bg-gray-100">
            <tr>
                <th class="p-2 text-left border-b-2 border-gray-200">Type</th>
                <th class="p-2 text-right border-b-2 border-gray-200"># Queries</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P50 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P95 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P99 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">Min (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">Max (ms)</th>
                <th x-show="mode === 'history'" class="p-2 text-left border-b-2 border-gray-200">Data</th>
            </tr>
        </thead>
        <tbody>
            <tr x-show="(templateInfo?.point_lookup_count || 0) + (templateInfo?.range_scan_count || 0) > 0">
                <td class="p-2 border-b border-gray-200 font-medium">Reads</td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatCompact((templateInfo?.point_lookup_count || 0) + (templateInfo?.range_scan_count || 0))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('read_p50_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('read_p95_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('read_p99_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('read_min_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('read_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2 border-b border-gray-200">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('POINT_LOOKUP,RANGE_SCAN')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
            <tr x-show="(templateInfo?.insert_count || 0) + (templateInfo?.update_count || 0) > 0">
                <td class="p-2 border-b border-gray-200 font-medium">Writes</td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatCompact((templateInfo?.insert_count || 0) + (templateInfo?.update_count || 0))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('write_p50_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('write_p95_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('write_p99_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('write_min_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('write_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2 border-b border-gray-200">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('INSERT,UPDATE')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
        </tbody>
    </table>

    <h4 class="mt-6 mb-2 font-semibold">Per-Query-Type Latency</h4>
    <table class="w-full border-collapse mt-2">
        <thead class="bg-gray-100">
            <tr>
                <th class="p-2 text-left border-b-2 border-gray-200">Query Type</th>
                <th class="p-2 text-right border-b-2 border-gray-200"># Queries</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P50 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P95 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">P99 (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">Min (ms)</th>
                <th class="p-2 text-right border-b-2 border-gray-200">Max (ms)</th>
                <th x-show="mode === 'history'" class="p-2 text-left border-b-2 border-gray-200">Data</th>
            </tr>
        </thead>
        <tbody>
            <tr x-show="(templateInfo?.point_lookup_count || 0) > 0">
                <td class="p-2 border-b border-gray-200 font-medium">Point Lookup</td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatCompact(templateInfo?.point_lookup_count || 0)"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('point_lookup_p50_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('point_lookup_p95_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('point_lookup_p99_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('point_lookup_min_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('point_lookup_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2 border-b border-gray-200">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('POINT_LOOKUP')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
            <tr x-show="(templateInfo?.range_scan_count || 0) > 0">
                <td class="p-2 border-b border-gray-200 font-medium">Range Scan</td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatCompact(templateInfo?.range_scan_count || 0)"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('range_scan_p50_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('range_scan_p95_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('range_scan_p99_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('range_scan_min_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('range_scan_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2 border-b border-gray-200">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('RANGE_SCAN')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
            <tr x-show="(templateInfo?.insert_count || 0) > 0">
                <td class="p-2 border-b border-gray-200 font-medium">Insert</td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatCompact(templateInfo?.insert_count || 0)"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('insert_p50_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('insert_p95_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('insert_p99_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('insert_min_latency_ms'))"></td>
                <td class="p-2 text-right border-b border-gray-200" x-text="formatMs(detailLatency('insert_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2 border-b border-gray-200">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('INSERT')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
            <tr x-show="(templateInfo?.update_count || 0) > 0">
                <td class="p-2 font-medium">Update</td>
                <td class="p-2 text-right" x-text="formatCompact(templateInfo?.update_count || 0)"></td>
                <td class="p-2 text-right" x-text="formatMs(detailLatency('update_p50_latency_ms'))"></td>
                <td class="p-2 text-right" x-text="formatMs(detailLatency('update_p95_latency_ms'))"></td>
                <td class="p-2 text-right" x-text="formatMs(detailLatency('update_p99_latency_ms'))"></td>
                <td class="p-2 text-right" x-text="formatMs(detailLatency('update_min_latency_ms'))"></td>
                <td class="p-2 text-right" x-text="formatMs(detailLatency('update_max_latency_ms'))"></td>
                <td x-show="mode === 'history'" class="p-2">
                    <a
                        class="btn btn-secondary btn-sm"
                        :href="testId ? `/dashboard/history/${testId}/data?kinds=${encodeURIComponent('UPDATE')}` : '#'"
                    >
                        Go to data
                    </a>
                </td>
            </tr>
        </tbody>
    </table>
</div>

</div><!-- end data-section="latency" wrapper -->

